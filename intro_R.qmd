# En veldig kjapp intro til R

```{r}
#| echo: false
#| message: false
#| warning: false
invisible(Sys.setlocale(locale='no_NB.utf8'))
```


Før vi setter igang trengs det en kort introduksjon til noe grunnleggende om hvordan R fungerer. Så lærer man mer underveis, og et senere kapittel går grundigere inn i datahåndtering og omkoding av variable. En grundigere gjennomgang av R finner du i @r4ds.

### Et par hurtigtaster
Du skriver altså kode i script-vinduet i RStudio. For å kjøre koden kan du klikke på "Run" opp i høyre hjørne av script-vinduet. Det kan være lurt å markere det du vil kjøre før du klikker "Run" slik at du bare kjører akkurat det du har tenkt til. Man blir fort lei av å klikke på den måten. En hurtigtast er **Ctlr + Enter** som altså gjør det samme.

Du vil komme til å skrive `%>%` ganske mange ganger etterhvert. Det er litt styrete å skrive pga hvordan tastene ligger på tastaturet ditt. En hurtigtast for dette tegnet er **Ctrl + Shift + M**.

Det er mange andre hurtigtaster tilgjengelig, men det er disse to du vil ha mest bruk for.

### Problemer med æøå?
På noen datamaskiner vil æøå vises feil. Det er jo veldig irriterende. R henter informasjon fra operativsystemet ditt for å vite hva slags tegnsetting som skal brukes. Noen ganger skjer det feil. Her er en kode for å sette tegnsetting til norsk:

```{r}
#| eval: false
Sys.setlocale(locale='no_NB.utf8')
```
Det kan hende du må kjøre denne koden hver gang du starter R.


## Objektorientert

R er bygd opp rundt å bruke "objekter" i den forstand at alt man jobber med (typisk: datasett) ligger i objekter.

Du kan tenke på objekter som en boks som det står et navn på. Ofte er det bare et datasett oppi boksen, men det kan også være flere ting. Det finnes derfor *flere typer objekter*. Vi skal primært jobbe med datasett, og slike objekter er av typen "data.frame". De kan også være av typen "tibble", men det er for alle praktiske formål på dette nivået akkurat det samme som "data.frame". Men objekter kan også inneholde resultater fra analyser, som f.eks. grafikk, tabeller eller regresjonsresultater. Man kan også legge enkelttall, vektorer og tekststrenger i objekter.

Noen ganger vil et objekt inneholde flere forskjellige ting. Et eksempel er resultat fra regresjonsmodeller som både vil inneholde koeffisienter, standardfeil, residualer, en del statistikker, men også selve datasettet. Men for å se på output er det funksjoner som trekker ut akkurat det vi trenger, så du trenger sjelden forholde deg til hvordan et slikt objekt er bygd opp.

Poenget er: Alt du jobber med i R er objekter. Alle objekter har et navn som du velger selv. Du kan legge hva som helst i et objekt. Du kan ikke ha to objekter med samme navn, og hvis du lager et objekt med et navn som eksisterer fra før overskriver du det gamle objektet.

## Funksjoner

Alt man gjør i R gjøres med "funksjoner", og man bruker funksjonene på objekter eller deler av objekter. Funksjonen har et navn etterfulgt av en parentes slik som f.eks. `dinfunksjon(...)`. Du kan tenke på funksjoner som en liten maskin der du putter noe inn, og så kommer noe annet ut. Det du putter inn skal stå inni parentesen. Det som kommer ut kan du enten legge i et eget objekt eller la det skrives til output-vinduet.

Det du legger inn i funksjonen -- altså inni parentesen -- kalles "argumenter". Hvert argument har et navn og du skal normalt oppgi i hvert fall hvilket datasett funksjonen skal brukes på. Argumentet for data er nettopp `data =` og så oppgis navnet på det objektet dataene ligger i.

I tillegg kan det være en rekke andre argumenter. Et poeng er viktig å presisere: argumentene har også en forventet *rekkefølge*. Man kan også oppgi argumentene uten å angi navnet hvis de kommer i riktig rekkefølge. Man kan godt oppgi argumentene i annen rekkefølge, men da er man nødt til å bruke argumentnavnet slik at R forstår hva som er hva.

## R-pakker

Når man installerer R har man svært mye funksjonalitet tilgjengelig uten videre. Dette kalles "base R". Men R er i praksis basert på å bruke såkalte "pakker". Dette er funksjoner som utvider R sin funksjonalitet.

R-pakker er et helt økosystem av funksjonalitet, og det finnes mange tusen R-pakker tilgjengelig på en server som heter CRAN. For nye brukere av R vil dette fremstå som ganske kaotisk, men du får beskjed om hvilke pakker du trenger fortløpende.

For å installere en pakke må du vite hva pakken heter og datamaskinen din må være koblet til internett:

```{r}
#| eval: false
install.packages("pakkenavn")
```

Vanlige grunner til feilmeldinger ved installering:

1) Du har stavet navnet på pakken feil. Pass på små og store bokstaver.
2) Pakken krever at du har noen andre pakker installert fra før. Installer disse først og prøv igjen.
3) Noen andre pakker trenger oppdatering. Oppdater alle pakker og prøv på nytt.
4) Din R-installasjon må oppdateres.

Når en pakke er installert må du "laste" den for at funksjonene skal være tilgjengelig i din R-sesjon. Hvis du restarter R, så må du laste pakkene på nytt.

```{r}
#| eval: false
library(pakkenavn)
```

For denne boken trenger du følgende pakker:

```{r}
#| eval: false
install.packages( c("tidyverse", "haven", "gtsummary", "gt", "modelsummary",
                    "labelled", "marginaleffects",
                    "causaldata", "gapminder", "palmerpenguins",
                    "sf", "tmap", "spData",
                    "tidygraph", "ggraph")
            )
```

Installering av pakker gjør du bare én gang. Du må derimot laste pakker hver gang du starter R på nytt.


## R-dialekter

De funksjonene som følger med grunnleggende installasjon av R kalles "base R". Man kan gjøre svært mye med bare base R. Men noen R-pakker inneholder ikke bare enkeltfunksjoner, men nesten et helt programmeringsspråk i seg selv. Det er lurt å holde seg innenfor samme "dialekt" da man ellers kan bli veldig forvirret. I denne boken bruker vi dialekten **tidyverse** konsekvent.

Merk at det finnes andre dialekter som er spesialiserte for spesifikke formål. Et eksempel er {data.table} som er lynrask for store datasett (se eget kapittel). Dette gjør at det kan være vanskelig å søke på nettet etter løsninger fordi du kan få svar i en annen dialekt enn den du kan.

### Tidyverse

Når man laster pakken {tidyverse} laster man egentlig flere pakker som også kan lastes individuelt. "Tidy" betyr "ryddig" og hensikten er et språk som er så ryddig og logisk som mulig. Full oversikt over pakkene som inngår i [Tidyverse finner du på deres hjemmeside](https://www.tidyverse.org/).

Grunnleggende datahåndtering med tidyverse dekkes i et eget kapittel (Del III). Grafikk med ggplot dekkes i Del IV. Her introduseres bare det aller mest grunnleggende.


### Pipe: `%>%`

Et viktig konsept i tidyverse er "pipen" `%>%` (hurtigtast: Ctrl + Shift + M). Den betyr "gjør deretter". Du kan binde sammen flere operasjoner i en arbeidsflyt:

```{r}
#| eval: false
dinedata %>%
  mutate(ny_variabel = gammel * 2) %>%
  filter(gruppe == "a")
```

Dette leses som: "start med dinedata, lag deretter en ny variabel, filtrer deretter på gruppe a."


### Logiske operatorer

I mange sammenhenger setter man *hvis*-krav. Her er grunnleggende logiske operatorer:

| Uttrykk                        | Kode            |
|--------------------------------|-----------------|
| er lik                         | `==`            |
| er ikke lik                    | `!=`            |
| og                             | `&`             |
| eller                          | `|`             |
| større/mindre enn              | `>` eller `<`   |
| større/mindre enn eller er lik | `<=` eller `>=` |


### Lagre data

Du kan som et utgangspunkt tenke at du *ikke* skal lagre bearbeidede data på disk. Scriptet ditt starter med å lese inn de originale dataene og gjør alt du trenger fra start til slutt. På den måten har du reproduserbare script.

Hvis du likevel trenger å lagre data til disk, bruk .rds-formatet:

```{r}
#| eval: false
saveRDS(dinedata, "data/dinedata_temp.rds")
```

For permanent lagring og deling av data, bruk csv-format:

```{r}
#| eval: false
write_csv(dinedata, "data/dinedata_temp.csv")
```


## Hjelpfiler og dokumentasjon

Dokumentasjonen i R åpnes med `?` foran funksjonsnavnet, f.eks. `?read.csv`. Hjelpfiler har en fast struktur: **Usage** viser syntaks med forvalgsverdier, **Arguments** forklarer hvert argument, **Examples** viser kodeeksempler.

Mange pakker har også "vignetter" som gir mer utfyllende forklaringer. Disse finnes på pakkens CRAN-side eller på egne nettsider.

### Bruke pakker uten å laste dem

En funksjon fra en spesifikk pakke kan angis med `pakkenavn::funksjon()`. Dette er nyttig hvis det er navnekonflikt mellom pakker:

```{r}
#| eval: false
dplyr::summarise(dinedata, antall = n(), snitt = mean(varA))
```
