{
  "hash": "7374775c0cc023954f36f161436d9335",
  "result": {
    "engine": "knitr",
    "markdown": "# Omkoding av variable\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(haven)\n```\n:::\n\n\n\n::: {.cell}\n\n:::\n\n\nÅ omkode variable er noe du vil gjøre veldig ofte. Noen ganger trenger du å slå sammen kategorier, andre ganger trenger du å lage helt nye variable basert på eksisterende. Det kan handle om å lage aldersgrupper fra en kontinuerlig aldersvariabel, slå sammen utdanningskategorier, eller gjøre om en variabel til en annen type. I dette kapittelet går vi gjennom de viktigste teknikkene.\n\n## Factor-variable\n\nFactor-variable er Rs måte å håndtere kategoriske data på. En factor har definerte *nivåer* (levels) som angir de mulige verdiene. La oss se på et eksempel:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclass(abu89$klasse89)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"factor\"\n```\n\n\n:::\n\n```{.r .cell-code}\nlevels(abu89$klasse89)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"I Øvre serviceklasse\"     \"II Nedre serviceklasse\"  \n[3] \"III Rutinefunksjonærer\"   \"V-VI Faglærte arbeidere\" \n[5] \"VIIa Ufaglærte arbeidere\"\n```\n\n\n:::\n:::\n\n\nVi kan se at variabelen `klasse89` er en factor med fem nivåer. Rekkefølgen på nivåene har betydning, blant annet for hvilken kategori som blir referansekategori i regresjonsanalyser.\n\n### Lage factor fra tall\n\nHvis du har en numerisk variabel som egentlig er kategorisk, kan du gjøre den om til factor:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89 <- abu89 %>%\n  mutate(kjonn = factor(ifelse(female == 1, \"Kvinne\", \"Mann\"),\n                        levels = c(\"Mann\", \"Kvinne\")))\n\ntable(abu89$kjonn)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  Mann Kvinne \n  2193   1934 \n```\n\n\n:::\n:::\n\n\nMed `levels =` bestemmer du rekkefølgen. Den første kategorien blir referansekategori i regresjon.\n\n## Omkoding med `ifelse()`\n\nDen enkleste formen for omkoding er `ifelse()`. Den tester en betingelse og gir én verdi hvis betingelsen er sann og en annen hvis den er usann:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89 <- abu89 %>%\n  mutate(hoylonn = ifelse(time89 > 100, \"Høy lønn\", \"Lav lønn\"))\n\ntable(abu89$hoylonn)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nHøy lønn Lav lønn \n    1007     2752 \n```\n\n\n:::\n:::\n\n\nHer er `time89 > 100` betingelsen. Alle som har timelønn over 100 får verdien \"Høy lønn\", resten får \"Lav lønn\".\n\n## Omkoding med `case_when()`\n\nNår du har mer enn to kategorier, er `case_when()` mye mer oversiktlig enn nestede `ifelse()`-kall:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89 <- abu89 %>%\n  mutate(aldersgruppe = case_when(\n    age < 25 ~ \"Under 25\",\n    age < 35 ~ \"25-34\",\n    age < 45 ~ \"35-44\",\n    age < 55 ~ \"45-54\",\n    age >= 55 ~ \"55 og over\"\n  ))\n\ntable(abu89$aldersgruppe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n     25-34      35-44      45-54 55 og over   Under 25 \n      1061       1179        790        595        502 \n```\n\n\n:::\n:::\n\n\nMerk at `case_when()` evaluerer betingelsene *ovenfra og ned*. Den stopper ved den første betingelsen som er sann. Derfor trenger vi ikke skrive `age >= 25 & age < 35` for den andre linjen - alle under 25 er allerede fanget opp av første linje.\n\n::: {.callout-tip}\nHvis ingen av betingelsene er sanne, får verdien `NA`. Du kan legge til `.default = \"Annet\"` som siste argument for å fange opp alt som ikke matcher.\n:::\n\nResultatet av `case_when()` er en tekstvariabel. Hvis du vil ha den som factor med bestemt rekkefølge, kan du pakke det inn i `factor()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89 <- abu89 %>%\n  mutate(aldersgruppe = factor(\n    case_when(\n      age < 25 ~ \"Under 25\",\n      age < 35 ~ \"25-34\",\n      age < 45 ~ \"35-44\",\n      age < 55 ~ \"45-54\",\n      age >= 55 ~ \"55 og over\"\n    ),\n    levels = c(\"Under 25\", \"25-34\", \"35-44\", \"45-54\", \"55 og over\")\n  ))\n\nlevels(abu89$aldersgruppe)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Under 25\"   \"25-34\"      \"35-44\"      \"45-54\"      \"55 og over\"\n```\n\n\n:::\n:::\n\n\n## Lage grupper med `cut()`\n\nFor å dele en kontinuerlig variabel inn i grupper er `cut()` et hendig alternativ:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89 <- abu89 %>%\n  mutate(aldersgruppe2 = cut(age,\n                             breaks = c(0, 25, 35, 45, 55, 100),\n                             labels = c(\"Under 25\", \"25-34\", \"35-44\",\n                                       \"45-54\", \"55+\")))\n\ntable(abu89$aldersgruppe2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nUnder 25    25-34    35-44    45-54      55+ \n     587     1092     1171      745      532 \n```\n\n\n:::\n:::\n\n\n`breaks` angir grensene og `labels` angir navnene på gruppene. Merk at det alltid er én label mindre enn antall grenseverdier.\n\n## Endre factor-nivåer med forcats\n\nPakken `forcats` (en del av tidyverse) har en rekke nyttige funksjoner for å jobbe med factor-variable.\n\n### Slå sammen kategorier med `fct_collapse()`\n\nHvis du har for mange kategorier og vil slå noen sammen:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89 <- abu89 %>%\n  mutate(klasse_enkel = fct_collapse(klasse89,\n    \"Service\" = c(\"I: Øvre serviceklasse\", \"II: Nedre serviceklasse\"),\n    \"Rutine\" = c(\"III: Rutinefunksjonærer\"),\n    \"Arbeider\" = c(\"V-VI: Faglærte arbeidere\", \"VII: Ufaglærte arbeidere\")\n  ))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: There was 1 warning in `mutate()`.\nℹ In argument: `klasse_enkel = fct_collapse(...)`.\nCaused by warning:\n! Unknown levels in `f`: I: Øvre serviceklasse, II: Nedre serviceklasse, III: Rutinefunksjonærer, V-VI: Faglærte arbeidere, VII: Ufaglærte arbeidere\n```\n\n\n:::\n\n```{.r .cell-code}\ntable(abu89$klasse_enkel)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n    I Øvre serviceklasse   II Nedre serviceklasse   III Rutinefunksjonærer \n                     328                     1181                     1248 \n V-VI Faglærte arbeidere VIIa Ufaglærte arbeidere \n                     648                      637 \n```\n\n\n:::\n:::\n\n\n### Gi nye navn med `fct_recode()`\n\nNoen ganger vil du bare endre navnene uten å slå sammen:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89 <- abu89 %>%\n  mutate(klasse_kort = fct_recode(klasse89,\n    \"I\" = \"I: Øvre serviceklasse\",\n    \"II\" = \"II: Nedre serviceklasse\",\n    \"III\" = \"III: Rutinefunksjonærer\",\n    \"V-VI\" = \"V-VI: Faglærte arbeidere\",\n    \"VII\" = \"VII: Ufaglærte arbeidere\"\n  ))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: There was 1 warning in `mutate()`.\nℹ In argument: `klasse_kort = fct_recode(...)`.\nCaused by warning:\n! Unknown levels in `f`: I: Øvre serviceklasse, II: Nedre serviceklasse, III: Rutinefunksjonærer, V-VI: Faglærte arbeidere, VII: Ufaglærte arbeidere\n```\n\n\n:::\n\n```{.r .cell-code}\ntable(abu89$klasse_kort)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n    I Øvre serviceklasse   II Nedre serviceklasse   III Rutinefunksjonærer \n                     328                     1181                     1248 \n V-VI Faglærte arbeidere VIIa Ufaglærte arbeidere \n                     648                      637 \n```\n\n\n:::\n:::\n\n\nMerk syntaksen: `\"nytt navn\" = \"gammelt navn\"`.\n\n### Endre rekkefølge med `fct_relevel()`\n\nFor å endre hvilken kategori som er først (og dermed referansekategori i regresjon):\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89 <- abu89 %>%\n  mutate(klasse_omvendt = fct_relevel(klasse89, \"VII: Ufaglærte arbeidere\"))\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: There was 1 warning in `mutate()`.\nℹ In argument: `klasse_omvendt = fct_relevel(klasse89, \"VII: Ufaglærte\n  arbeidere\")`.\nCaused by warning:\n! 1 unknown level in `f`: VII: Ufaglærte arbeidere\n```\n\n\n:::\n\n```{.r .cell-code}\nlevels(abu89$klasse_omvendt)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"I Øvre serviceklasse\"     \"II Nedre serviceklasse\"  \n[3] \"III Rutinefunksjonærer\"   \"V-VI Faglærte arbeidere\" \n[5] \"VIIa Ufaglærte arbeidere\"\n```\n\n\n:::\n:::\n\n\nNå er \"VII: Ufaglærte arbeidere\" flyttet til første posisjon og vil bli referansekategori.\n\n### Sortere etter en annen variabel med `fct_reorder()`\n\nNoen ganger vil du sortere kategoriene etter en annen variabel, for eksempel for å lage pene grafer:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89 %>%\n  filter(!is.na(klasse89), !is.na(time89)) %>%\n  mutate(klasse89 = fct_reorder(klasse89, time89, .fun = mean)) %>%\n  ggplot(aes(x = klasse89, y = time89)) +\n  geom_boxplot() +\n  coord_flip()\n```\n\n::: {.cell-output-display}\n![](omkoding_files/figure-epub/unnamed-chunk-13-1.png)\n:::\n:::\n\n\nHer sorteres klassekategoriene etter gjennomsnittlig timelønn, slik at den klassen med lavest lønn kommer først.\n\n### Fjerne ubrukte nivåer med `fct_drop()`\n\nEtter filtrering kan du sitte igjen med factor-nivåer som ikke lenger har observasjoner:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89_lite <- abu89 %>%\n  filter(klasse89 %in% c(\"I: Øvre serviceklasse\", \"II: Nedre serviceklasse\"))\n\n# Ubrukte nivåer er fortsatt der\nlevels(abu89_lite$klasse89)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"I Øvre serviceklasse\"     \"II Nedre serviceklasse\"  \n[3] \"III Rutinefunksjonærer\"   \"V-VI Faglærte arbeidere\" \n[5] \"VIIa Ufaglærte arbeidere\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# Fjern dem\nabu89_lite <- abu89_lite %>%\n  mutate(klasse89 = fct_drop(klasse89))\n\nlevels(abu89_lite$klasse89)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ncharacter(0)\n```\n\n\n:::\n:::\n\n\n## Jobbe med tekst\n\nNoen ganger trenger du å jobbe med tekstverdier. Pakken `stringr` (en del av tidyverse) har nyttige funksjoner:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Finne tekst i en variabel\nabu89 %>%\n  filter(str_detect(as.character(klasse89), \"service\")) %>%\n  head(3) %>%\n  select(klasse89, time89)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 3 × 2\n  klasse89               time89\n  <fct>                   <dbl>\n1 II Nedre serviceklasse   91.3\n2 II Nedre serviceklasse   84.2\n3 II Nedre serviceklasse   90.4\n```\n\n\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Erstatte tekst\nabu89 %>%\n  mutate(klasse_ny = str_replace(as.character(klasse89), \"klasse\", \"kl.\"))\n```\n:::\n\n\n## Praktisk eksempel: komplett omkoding\n\nHer er et eksempel som viser en typisk omkodingsprosess der vi forbereder data til analyse:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89_analyse <- abu89 %>%\n  mutate(\n    # Lage kjønnsvariabel som factor\n    kjonn = factor(ifelse(female == 1, \"Kvinne\", \"Mann\"),\n                   levels = c(\"Mann\", \"Kvinne\")),\n    # Lage aldersgrupper\n    alder_gr = cut(age, breaks = c(0, 30, 40, 50, 100),\n                   labels = c(\"Under 30\", \"30-39\", \"40-49\", \"50+\")),\n    # Forenkle klassevariabel\n    klasse = fct_collapse(klasse89,\n      \"Serviceklasse\" = c(\"I: Øvre serviceklasse\", \"II: Nedre serviceklasse\"),\n      \"Rutine\" = \"III: Rutinefunksjonærer\",\n      \"Arbeiderklasse\" = c(\"V-VI: Faglærte arbeidere\", \"VII: Ufaglærte arbeidere\")\n    ),\n    # Lage dummy for høy lønn\n    hoylonn = ifelse(time89 > median(time89, na.rm = TRUE), 1, 0)\n  ) %>%\n  select(time89, hoylonn, kjonn, age, alder_gr, klasse)\n\nglimpse(abu89_analyse)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 4,127\nColumns: 6\n$ time89   <dbl> 62.00000, NA, 91.32895, 84.23913, 90.42553, 103.28947, 75.000…\n$ hoylonn  <dbl> 0, NA, 1, 1, 1, 1, 0, 1, 0, 1, 1, NA, 0, 1, NA, 1, 0, 1, 1, 0…\n$ kjonn    <fct> Kvinne, Mann, Kvinne, Kvinne, Mann, Mann, Kvinne, Mann, Mann,…\n$ age      <dbl> 58, 24, 44, 46, 40, 36, 31, 31, 26, 29, 54, 58, 25, 25, 56, 5…\n$ alder_gr <fct> 50+, Under 30, 40-49, 40-49, 30-39, 30-39, 30-39, 30-39, Unde…\n$ klasse   <fct> III Rutinefunksjonærer, VIIa Ufaglærte arbeidere, II Nedre se…\n```\n\n\n:::\n:::\n\n\n## Oppsummering\n\n| Oppgave | Funksjon | Eksempel |\n|---------|----------|----------|\n| To kategorier | `ifelse()` | `ifelse(x > 10, \"Høy\", \"Lav\")` |\n| Flere kategorier | `case_when()` | `case_when(x < 10 ~ \"Lav\", ...)` |\n| Kutte kontinuerlig | `cut()` | `cut(x, breaks = c(0,10,20))` |\n| Slå sammen nivåer | `fct_collapse()` | `fct_collapse(x, A = c(\"a\",\"b\"))` |\n| Endre navn | `fct_recode()` | `fct_recode(x, \"Ny\" = \"Gml\")` |\n| Endre rekkefølge | `fct_relevel()` | `fct_relevel(x, \"Sist\")` |\n| Sortere etter verdi | `fct_reorder()` | `fct_reorder(x, y, mean)` |\n| Fjerne tomme nivåer | `fct_drop()` | `fct_drop(x)` |\n",
    "supporting": [
      "omkoding_files\\figure-epub"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}