{
  "hash": "0ec6a369586f33160408b8cbeea2e3d0",
  "result": {
    "engine": "knitr",
    "markdown": "# Kart og romlige data\n\n\n\n\n\n\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(sf)\n```\n:::\n\n\n\n\n\n\n\n\nI samfunnsvitenskapen er vi ofte interessert i geografisk variasjon. Hvordan varierer kriminaliteten mellom kommuner? Hvor er det flest barnefamilier? Er det regionale forskjeller i valgdeltakelse? Slike sporsmal er mye lettere a forstaa med et kart enn med en tabell. Et kart gir deg umiddelbar oversikt over romlige monstre som kan vaere vanskelig a fange opp ellers.\n\nI R kan vi lage kart med de samme verktoyene vi allerede kjenner fra ggplot. Det er pakken `sf` (som star for *simple features*) som gjor det mulig a jobbe med geografiske data, og den fungerer smutt sammen med tidyverse.\n\n\n## Geografiske data og sf-pakken\n\nGeografiske data er i bunn og grunn vanlige datasett med en ekstra kolonne som inneholder geometri -- alts de geografiske formene. Det kan vaere polygoner (som kommunegrenser), linjer (som veier) eller punkter (som adresser). Pakken `sf` handterer alt dette og lar deg bruke vanlige tidyverse-funksjoner som `filter()`, `mutate()` og `left_join()` pa geografiske data.\n\nHvis du ikke har installert `sf` fra for, gjor du det slik:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"sf\")\n```\n:::\n\n\n\n\n\n\n\n\n\n## Lese inn kartdata\n\nKartdata kommer typisk i formater som *shapefile* (.shp) eller *GeoJSON* (.geojson). Funksjonen `st_read()` leser begge deler. Her henter vi kommunegrenser fra Geonorge, som er den nasjonale portalen for geografiske data i Norge.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkommuner <- st_read(\"https://nedlasting.geonorge.no/geonorge/Basisdata/Kommuner/GeoJSON/Basisdata_0000_Norge_25833_Kommuner_GeoJSON.geojson\")\n```\n:::\n\n\n\n\n\n\n\n\nDenne filen er ganske stor, sa det kan ta litt tid a laste ned. Hvis du har lastet ned filen til din egen maskin, leser du den inn slik:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkommuner <- st_read(\"sti/til/kommuner.geojson\")\n```\n:::\n\n\n\n\n\n\n\n\nLa oss se hva vi har fatt:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(kommuner)\n```\n:::\n\n\n\n\n\n\n\n\nDu vil se at dette ser ut som en vanlig data.frame, men med en ekstra kolonne som heter `geometry`. Det er der de geografiske formene ligger. Ellers har du kolonner med kommunenummer, kommunenavn og annen informasjon.\n\n\n## Grunnleggende kart med ggplot\n\nNar du har et sf-objekt, kan du plotte det direkte med `geom_sf()`. Det er like enkelt som annen ggplot-grafikk:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(kommuner) +\n  geom_sf() +\n  theme_minimal()\n```\n:::\n\n\n\n\n\n\n\n\nDette gir deg et enkelt kart over alle kommuner i Norge. Merk at du ikke trenger a spesifisere x- og y-akser -- det ordner `geom_sf()` selv basert pa geometrien.\n\n\n## Koropletkart: fargelegge regioner etter en variabel\n\nEt koropletkart er et kart der omradene er fargelagt etter en variabel. For a lage dette trenger vi forst noen data a koble pa kartet. La oss lage et lite eksempeldatasett med fiktive verdier:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Anta at kommuner-datasettet har en kolonne \"kommunenummer\"\n# Vi lager noen eksempeldata\neksempel <- kommuner %>%\n  mutate(tilfeldig_verdi = rnorm(n()))\n```\n:::\n\n\n\n\n\n\n\n\nNa kan vi fargelegge kartet etter denne variabelen:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(eksempel) +\n  geom_sf(aes(fill = tilfeldig_verdi)) +\n  scale_fill_viridis_c() +\n  theme_minimal() +\n  labs(fill = \"Verdi\")\n```\n:::\n\n\n\n\n\n\n\n\nFunksjonen `scale_fill_viridis_c()` gir en fargeskala som er lesbar ogsa for fargeblinde. Du kan ogsa bruke andre fargeskalaer, f.eks. `scale_fill_gradient(low = \"white\", high = \"red\")`.\n\n\n## Koble data til kartgeometrier\n\nI praksis har du som regel dataene dine i et eget datasett og kartgeometriene i et annet. Da ma du koble dem sammen med `left_join()`. Nokkelfeltet er typisk kommunenummer.\n\nLa oss si at du har et datasett med befolkningstall per kommune:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Eksempel: les inn dine data\nmine_data <- data.frame(\n  kommunenummer = c(\"0301\", \"1103\", \"4601\", \"5001\"),\n  innbyggere = c(709037, 144704, 291189, 212660),\n  kommune = c(\"Oslo\", \"Stavanger\", \"Bergen\", \"Trondheim\")\n)\n\n# Koble til kartdata\nkart_med_data <- kommuner %>%\n  left_join(mine_data, by = \"kommunenummer\")\n\n# Plott\nggplot(kart_med_data) +\n  geom_sf(aes(fill = innbyggere)) +\n  scale_fill_viridis_c(labels = scales::comma) +\n  theme_minimal() +\n  labs(fill = \"Innbyggere\")\n```\n:::\n\n\n\n\n\n\n\n\nMerk at kolonnenavnet for kommunenummer ma vaere likt i begge datasettene. Sjekk ogsa at formatet er det samme (f.eks. at begge er tekststrenger med ledende nuller).\n\n\n## Legge til punkter pa kartet\n\nNoen ganger onsker du a plotte enkeltlokasjoner pa kartet, for eksempel hendelser eller institusjoner. Da trenger du koordinater (lengde- og breddegrad) som du gjor om til et sf-objekt med `st_as_sf()`.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsteder <- data.frame(\n  navn = c(\"Oslo\", \"Bergen\", \"Trondheim\", \"Tromso\"),\n  lon = c(10.75, 5.33, 10.40, 18.96),\n  lat = c(59.91, 60.39, 63.43, 69.65)\n)\n\n# Gjor om til sf-objekt med koordinatreferansesystem WGS84 (EPSG:4326)\nsteder_sf <- st_as_sf(steder, coords = c(\"lon\", \"lat\"), crs = 4326)\n\n# Transformer til samme CRS som kartdataene\nsteder_sf <- st_transform(steder_sf, st_crs(kommuner))\n```\n:::\n\n\n\n\n\n\n\n\nNa kan du legge punktene opppa kartet som et eget lag:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = kommuner, fill = \"grey90\", color = \"grey70\") +\n  geom_sf(data = steder_sf, color = \"red\", size = 3) +\n  theme_minimal()\n```\n:::\n\n\n\n\n\n\n\n\nLegg merke til at vi her bruker `ggplot()` uten a spesifisere data forst, og i stedet angir `data =` i hvert `geom_sf()`-lag. Det gir oss full kontroll over hvilke datasett som brukes i hvert lag.\n\n\n## Koordinatreferansesystemer (CRS)\n\nAlle geografiske data har et koordinatreferansesystem (CRS) som sier noe om hvordan posisjoner pa jordkloden er representert. De to viktigste a vite om er:\n\n- **EPSG:4326** (WGS84): Lengde- og breddegrad i grader. Dette er det GPS bruker og det du finner pa Google Maps.\n- **EPSG:25833** (UTM sone 33N): Et projisert system i meter som er vanlig for norske kartdata. Geonorge bruker typisk dette.\n\nHvis du skal kombinere data med ulike CRS, ma du transformere til samme system:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Sjekk CRS\nst_crs(kommuner)\n\n# Transformer til en annen CRS\nkommuner_wgs84 <- st_transform(kommuner, 4326)\n```\n:::\n\n\n\n\n\n\n\n\nI praksis trenger du sjelden a tenke sa mye pa dette sa lenge du transformer til samme system for du kombinerer datasett.\n\n\n## Interaktive kart med leaflet\n\nNoen ganger er det nyttig med et interaktivt kart der man kan zoome og klikke. Pakken `leaflet` gjor dette enkelt:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"leaflet\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(leaflet)\n\n# Leaflet bruker WGS84, sa vi transformer forst\nkommuner_ll <- st_transform(kommuner, 4326)\n\nleaflet(kommuner_ll) %>%\n  addTiles() %>%\n  addPolygons(\n    fillColor = \"steelblue\",\n    weight = 1,\n    color = \"white\",\n    fillOpacity = 0.5\n  )\n```\n:::\n\n\n\n\n\n\n\n\nLeaflet-kart fungerer best i HTML-dokumenter og er saerlig nyttige nar du utforsker dataene selv. De er ikke egnet for trykte rapporter.\n\n\n## Kilder til norske geodata\n\nFor norske kartdata finnes det flere gode kilder:\n\n- **Geonorge** ([geonorge.no](https://www.geonorge.no/)): Norges nasjonale portal for geografiske data. Her finner du kommunegrenser, fylkesgrenser, kystlinjer og mye mer. Data er gratis og tilgjengelig i flere formater.\n- **SSB** ([ssb.no](https://www.ssb.no/kart/statistikkart)): Statistisk sentralbyra tilbyr kartdata tilpasset deres statistikk, inkludert grunnkretser og delomrader.\n- **Kartverket** ([kartverket.no](https://www.kartverket.no/)): Forvalter de offisielle kartdataene i Norge og tilbyr bl.a. topografiske data, stedsnavn og eiendomsdata.\n\nTil vanlig bruk i samfunnsvitenskapelige analyser er kommunegrensene fra Geonorge det du oftest trenger. Husk at kommuneinndelingen endrer seg over tid (kommunesammenslaainger), sa pass pa at kartdataene matcher tidsperioden i dine analysedata.\n\n\n## Praktisk eksempel: kriminalitetskart over Oslo\n\nLa oss na bruke det vi har laert til a lage et kriminalitetskart. Vi bruker en shapefil med Oslos 16 bydeler og et datasett med syntetiske kriminalitetshendelser som har x/y-koordinater. Dataene er generert for undervisningsformel, men illustrerer en realistisk arbeidsflyt for romlig analyse.\n\n\n### Lese inn shapefil\n\nShapefiler er et vanlig format for geografiske data. De bestar egentlig av flere filer (.shp, .dbf, .prj, .shx), men `st_read()` handterer dette automatisk -- du peker bare pa .shp-filen:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\noslo <- st_read(\"data/shapefiles/oslo.shp\", quiet = TRUE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(oslo)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 16\nColumns: 5\n$ AREA       <dbl> 13752297, 7727095, 8257591, 7506340, 4752848, 7041704, 1224…\n$ PERIMETER  <dbl> 24549.228, 15484.756, 28349.785, 37783.397, 12090.874, 2304…\n$ KODE       <chr> \"030112\", \"030109\", \"030105\", \"030101\", \"030102\", \"030110\",…\n$ BYDELSNAVN <chr> \"ALNA\", \"BJERKE\", \"FROGNER\", \"GAMLE OSLO\", \"GRÜNERLØKKA\", \"…\n$ geometry   <MULTIPOLYGON [m]> MULTIPOLYGON (((268660.9 66..., MULTIPOLYGON (…\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nVi ser at datasettet har 16 rader (en per bydel) med bydelskode, bydelsnavn og geometri. Geometrikolonnen inneholder polygonene som tegner bydelsgrensene.\n\n\n### Grunnkart over Oslo\n\nLa oss bygge opp et kart steg for steg, akkurat som med vanlig ggplot.\n\nDet enkleste mulige kartet:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(oslo) +\n  geom_sf()\n```\n\n::: {.cell-output-display}\n![](kart_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n`geom_sf()` forstar geometrien automatisk -- du trenger ikke spesifisere x- og y-akser. La oss forbedre utseendet:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(oslo) +\n  geom_sf(fill = \"gray95\") +\n  theme_void()\n```\n\n::: {.cell-output-display}\n![](kart_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n`theme_void()` fjerner akser og bakgrunn, som passer bedre for kart enn `theme_minimal()`. Na lagrer vi grunnkartet i et objekt slik at vi kan legge nye lag oppa:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkart <- ggplot(oslo) +\n  geom_sf(fill = \"gray95\") +\n  coord_sf(datum = st_crs(oslo)) +\n  theme_void()\nkart\n```\n\n::: {.cell-output-display}\n![](kart_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n`coord_sf(datum = st_crs(oslo))` sorger for at projeksjonen matcher kartdataene.\n\n\n### Lese inn og utforske kriminalitetsdata\n\nNa leser vi inn kriminalitetsdataene. Disse er lagret som en RDS-fil, som er et R-format vi har sett tidligere:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkrim <- readRDS(\"data/shapefiles/syntetisk_krim.rds\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(krim)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    saksnr krimtypekodenavn  aar maaned dag time      x       y\n1 14039877     05 NARKOTIKA 2017    Mar   4   21 270800 6653100\n2 13917288          03 VOLD 2016    Nov   2    3 261900 6649700\n3 14377224     05 NARKOTIKA 2018    Feb   6   20 262900 6649300\n4 13796941       02 VINNING 2016    Jul   3   23 262500 6649700\n5 14406573       02 VINNING 2017    Apr   7    0 264300 6649700\n6 14449912       02 VINNING 2018    May   4   14 261100 6649100\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(krim)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 198,365\nColumns: 8\n$ saksnr           <dbl> 14039877, 13917288, 14377224, 13796941, 14406573, 144…\n$ krimtypekodenavn <chr> \"05 NARKOTIKA\", \"03 VOLD\", \"05 NARKOTIKA\", \"02 VINNIN…\n$ aar              <dbl> 2017, 2016, 2018, 2016, 2017, 2018, 2018, 2017, 2016,…\n$ maaned           <chr> \"Mar\", \"Nov\", \"Feb\", \"Jul\", \"Apr\", \"May\", \"Mar\", \"Sep…\n$ dag              <dbl> 4, 2, 6, 3, 7, 4, 6, 5, 6, 5, 3, 6, 2, 3, 3, 5, 3, 1,…\n$ time             <dbl> 21, 3, 20, 23, 0, 14, 0, 0, 0, 14, 12, 21, 0, 18, 0, …\n$ x                <dbl> 270800, 261900, 262900, 262500, 264300, 261100, 26400…\n$ y                <dbl> 6653100, 6649700, 6649300, 6649700, 6649700, 6649100,…\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(krim$krimtypekodenavn)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n  02 VINNING      03 VOLD 05 NARKOTIKA 06 SKADEVERK \n      119387        29921        27455        21602 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nDatasettet har omtrent 198 000 hendelser. Hver rad er en kriminell hendelse med koordinater (`x` og `y` i UTM-meter), kriminalitetstype, ar, maned, ukedag og klokkeslett. Koordinatene er avrundet til 100-meters ruter.\n\n\n## Punktkart\n\nDen enkleste maten a vise hendelsene pa kartet er a plotte hvert punkt:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkart +\n  geom_point(data = krim, aes(x = x, y = y),\n             color = \"red\", alpha = 0.01, size = 0.01)\n```\n\n::: {.cell-output-display}\n![](kart_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nMed `alpha = 0.01` (nesten gjennomsiktig) og `size = 0.01` (sma punkter) kan vi vise alle hendelsene uten at kartet blir helt rodt. Tettere omrader far sterkere farge fordi mange halvgjennomsiktige punkter legges oppa hverandre.\n\n\n## Rasterkart (heatmap)\n\nPunktkartet over er nyttig for a se det overordnede monsteret, men for a sammenligne omrader mer presist trenger vi a *aggregere* dataene. Siden koordinatene allerede er avrundet til 100-meters ruter, kan vi telle antall hendelser per rute:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkrimplot <- krim %>%\n  group_by(x, y) %>%\n  summarise(antall = n()) %>%\n  mutate(antall = ifelse(antall >= 200, 200, antall))\n```\n:::\n\n\n\n\n\n\n\n\nVi begrenser verdiene til maksimalt 200 for a unnga at noen ekstremt tette ruter (typisk sentrum) dominerer hele fargeskalaen.\n\nNa kan vi lage et rasterkart der hver rute er fargelagt etter antall hendelser:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(krimplot, aes(x = x, y = y, fill = antall)) +\n  geom_tile() +\n  coord_sf(datum = st_crs(oslo)) +\n  theme_void() +\n  scale_fill_distiller(palette = \"Spectral\")\n```\n\n::: {.cell-output-display}\n![](kart_files/figure-html/unnamed-chunk-27-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n`geom_tile()` tegner en firkant per rute, fargelagt etter antall hendelser. `scale_fill_distiller(palette = \"Spectral\")` gir en fargeskala som gar fra blatt (fa hendelser) til rodt (mange hendelser).\n\nFor bedre kontekst legger vi til Oslos omriss oppa heatmapen:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\noslo_omkr <- st_union(oslo)\n\nkart +\n  geom_tile(data = krimplot, aes(x = x, y = y, fill = antall), alpha = 0.75) +\n  scale_fill_distiller(palette = \"Spectral\") +\n  geom_sf(data = oslo_omkr, color = \"black\", fill = NA) +\n  labs(fill = \"Hendelser\")\n```\n\n::: {.cell-output-display}\n![](kart_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n`st_union()` slar sammen alle bydelspolygonene til en ytre grense. `fill = NA` gjor at bare grenselinjen tegnes, slik at heatmapen synes gjennom. Merk at vi bruker grunnkartet (`kart`) som utgangspunkt og legger nye lag oppa -- akkurat samme prinsipp som med vanlige ggplot-figurer.\n\n\n## Oppdelt etter kriminalitetstype\n\nMed `facet_wrap()` kan vi lage ett delkart per kriminalitetstype. Vi aggregerer pa nytt, men na ogsa gruppert etter type:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nkrimplot_type <- krim %>%\n  group_by(x, y, krimtypekodenavn) %>%\n  summarise(antall = n()) %>%\n  mutate(antall = ifelse(antall >= 150, 150, antall))\n\nkart +\n  geom_tile(data = krimplot_type, aes(x = x, y = y, fill = antall), alpha = 0.75) +\n  scale_fill_distiller(palette = \"Spectral\") +\n  geom_sf(data = oslo_omkr, color = \"black\", fill = NA) +\n  facet_wrap(~krimtypekodenavn) +\n  labs(fill = \"Hendelser\")\n```\n\n::: {.cell-output-display}\n![](kart_files/figure-html/unnamed-chunk-29-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nNa ser vi at de ulike kriminalitetstypene har svart forskjellig geografisk fordeling. Vinningskriminalitet er spredt over hele byen, mens narkotika er mer konsentrert. `facet_wrap()` fungerer pa kart akkurat som pa vanlige ggplot-figurer.\n\n\n## Oppsummering\n\nKart i R folger samme logikk som annen ggplot-grafikk: du har data, du velger en geometrisk form (`geom_sf()`), og du tilpasser utseendet. Med `sf`-pakken kan du lese inn kartfiler, koble pa dine egne data, og lage bade statiske og interaktive kart. De viktigste funksjonene a huske er:\n\n| Funksjon           | Hva den gjor                               |\n|--------------------|---------------------------------------------|\n| `st_read()`        | Leser inn geografiske data                  |\n| `geom_sf()`        | Plotter sf-objekter i ggplot                |\n| `st_as_sf()`       | Gjor vanlig data.frame om til sf-objekt     |\n| `st_transform()`   | Endrer koordinatreferansesystem             |\n| `st_crs()`         | Sjekker koordinatreferansesystemet          |\n| `st_union()`       | Slar sammen geometrier til en               |\n| `geom_tile()`      | Tegner rasterkart (heatmap)                 |\n| `facet_wrap()`     | Deler kartet opp etter en variabel          |\n",
    "supporting": [
      "kart_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}