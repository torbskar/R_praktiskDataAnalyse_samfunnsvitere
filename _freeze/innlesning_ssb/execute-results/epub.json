{
  "hash": "d715543251a10f2e6cc11450e787b03a",
  "result": {
    "engine": "knitr",
    "markdown": "# Data fra SSBs statistikkbank\n\nAll statistikk fra SSB publiseres (også) i en statistikkbank der man kan hente ut f.eks. tidsserier over flere årganger. Du kan ta en titt på Statistikkbanken på [SSB sine sider](https://www.ssb.no/statbank). \n\nSSB har laget et r-pakke for å hente data direkte fra SSBs statistikkbank. Denne kan du installere direkte fra CRAN via R slik:    \n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"PxWebApiData\")\n```\n:::\n\n\n\n\n\n\n\nVi skal altså bruke følgende pakker i dette kapittelet: \n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(PxWebApiData)\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.2.0     ✔ readr     2.1.5\n✔ forcats   1.0.1     ✔ stringr   1.6.0\n✔ ggplot2   4.0.2     ✔ tibble    3.3.1\n✔ lubridate 1.9.4     ✔ tidyr     1.3.1\n✔ purrr     1.2.1     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Befolkning\nmeta<- ApiData(\"http://data.ssb.no/api/v0/en/table/07459\",  returnMetaFrames = TRUE)\nnames(meta)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Region\"       \"Kjonn\"        \"Alder\"        \"ContentsCode\" \"Tid\"         \n```\n\n\n:::\n\n```{.r .cell-code}\nmeta$Kjonn\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  values valueTexts\n1      2    Females\n2      1      Males\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n## Anmeldte lovbrudd\nmeta<- ApiData(\"http://data.ssb.no/api/v0/en/table/08487\",  returnMetaFrames = TRUE)\n\nkommuner <- meta$Gjerningssted %>% \n  filter(nchar(values) == 4 & !(values %in% c(\"Ialt\", \"0000\"))) %>% \n  pull(values)\n\ngrupper <- meta$LovbruddKrim %>% \n  filter(nchar(values) > 5 & valueTexts != \"All groups of offences\" ) %>% \n  pull(values)\n\n## Pull data from API\nanm_list <- ApiData(\"http://data.ssb.no/api/v0/en/table/08487\", \n                    ContentsCode = \"AnmLovbrPer1000\", \n                    Gjerningssted = kommuner, \n                    LovbruddKrim = grupper, \n                    Tid = TRUE,\n                    makeNAstatus = FALSE)\n\n\n# rename\nnames(anm_list[[1]]) <- c(\"kommune\", \"lovbruddsgruppe\", \"content\", \"year\", \"lovbrudd_per1000\", \"NAstatus\")\n\n\n# Combine and tidy up\nanm <- cbind(anm_list[[2]][1], anm_list[[1]]) %>%\n  select(-content, -NAstatus) %>%\n  mutate(lovbruddsgruppe = str_sub(lovbruddsgruppe, 3, nchar(lovbruddsgruppe))) %>% \n  mutate(year = as.numeric(str_sub(year,1,4))) %>% \n  filter(!is.na(lovbrudd_per1000)) %>% \n  mutate(lovbruddsgruppe = case_when(str_sub(lovbruddsgruppe, 1,4) == \"Prop\" ~ \"vinningskriminalitet\", \n                                     str_sub(lovbruddsgruppe, 1,4) == \"Viol\" ~ \"voldskriminalitet\",\n                                     str_sub(lovbruddsgruppe, 1,4) == \"Drug\" ~ \"nark_alko_kriminalitet\",\n                                     str_sub(lovbruddsgruppe, 1,4) == \"Publ\" ~ \"ordenslovbrudd\",\n                                     str_sub(lovbruddsgruppe, 1,4) == \"Traf\" ~ \"trafikklovbrudd\",\n                                     str_sub(lovbruddsgruppe, 1,4) == \"Othe\" ~ \"andre_lovbrudd\")) %>% \n  # pivot_wider(values_from = lovbrudd_per1000, names_from = lovbruddsgruppe) %>% \n  rename(kommune_nr = Gjerningssted) %>% \n  select(-kommune)\n\nglimpse(anm)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 36,866\nColumns: 4\n$ kommune_nr       <chr> \"3101\", \"3101\", \"3101\", \"3101\", \"3101\", \"3101\", \"3103…\n$ lovbruddsgruppe  <chr> \"vinningskriminalitet\", \"voldskriminalitet\", \"nark_al…\n$ year             <dbl> 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023, 2023,…\n$ lovbrudd_per1000 <dbl> 12.6, 11.6, 16.8, 13.2, 13.8, 18.0, 21.8, 7.4, 6.3, 5…\n```\n\n\n:::\n\n```{.r .cell-code}\n#Check\nggplot( filter(anm, kommune_nr == \"0301\"), \n        aes(x = year, y = lovbrudd_per1000, group = lovbruddsgruppe, linetype = lovbruddsgruppe))+\n  geom_line()+\n  theme(legend.position = \"bottom\", legend.title = element_blank())+\n  guides(linetype = guide_legend(ncol = 2))+\n  xlab(\"\")\n```\n\n::: {.cell-output-display}\n![](innlesning_ssb_files/figure-epub/unnamed-chunk-4-1.png)\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# meta$Alder\n# meta$Kjonn\n# meta$ContentsCode\n# meta$Region %>% head()\n\nkommuner_bef <- meta$Region %>% \n  filter(nchar(values) == 4 ) %>% \n  pull(values)\nhead(kommuner_bef)\n\n\nbefolk <- list(length(meta$Tid$values))\nfor(i in 1:length(meta$Tid$values)){ \n  #print(i)\n  bef_list <- ApiData(\"http://data.ssb.no/api/v0/en/table/07459\", \n                      ContentsCode = TRUE, \n                      Region = kommuner_bef, \n                      Kjonn = TRUE,  \n                      Alder = TRUE,\n                      Tid = i)\n  befolk[[i]] <- cbind(bef_list[[2]][1], bef_list[[1]])\n  \n  #rm(bef_list)\n  }\n\n\nbefolkning <- bind_rows(befolk)\n\n# rename\nnames(befolkning) <- c(\"kommune_nr\", \"kommune\", \"kjonn\", \"alder\", \"contents\", \"year\", \"bef_antall\")\n\n# Combine and tidy up\nbefolkning2 <- befolkning %>% \n  select(-contents) %>% \n  mutate(year = as.numeric(year)) %>% \n  mutate(age = str_extract(alder, \"(\\\\d)+\")) %>% \n  mutate(age_gr = case_when(age < 18 ~ \"under 18\", \n                            age <= 25 ~ \"18-25\",\n                            age <= 35 ~ \"26-35\", \n                            age <= 67 ~ \"36-67\", \n                            age > 67 ~ \"over 67\")) \n\nbef_gruppe <- befolkning2 %>% \n  group_by(kommune_nr, kommune, year, age_gr, kjonn) %>% \n  summarise(n = sum(bef_antall)) %>% \n  ungroup() %>% \n  pivot_wider(values_from = n, names_from = age_gr) %>% \n  rename(bef_18_25 = `18-25`, bef_26_35 = `26-35`, bef_36_67 = `36-67`, \n         bef_67plus = `over 67`, bef_18min = `under 18`) %>% \n  filter(year >= 2010) \n  \nbef_menn <- filter(bef_gruppe, kjonn == \"Males\") %>% \n  rename_all(str_replace_all, \"bef_\", \"menn_\") %>% \n  select(-kjonn, -kommune)\n\nbef_kvinner <- filter(bef_gruppe, kjonn == \"Females\") %>% \n  rename_all(str_replace_all, \"bef_\", \"kvinner_\") %>% \n  select(-kjonn, -kommune)\n\nhead(bef_kvinner)\n\n\nbef_tot <- befolkning2 %>% \n  group_by(kommune_nr, kommune, year, age_gr) %>% \n  summarise(n = sum(bef_antall)) %>% \n  ungroup() %>% \n  pivot_wider(values_from = n, names_from = age_gr) %>% \n  rename(bef_18_25 = `18-25`, bef_26_35 = `26-35`, bef_36_67 = `36-67`, \n         bef_67plus = `over 67`, bef_18min = `under 18`) %>% \n  filter(year >= 2010) %>% \n  rowwise() %>% \n  mutate(bef_totalt = sum( across(bef_18_25:bef_18min))) %>% \n  select(1:3, 8, 4, 5, 9)\n\nglimpse(bef_tot)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(bef, aes(x = year, y = value, group = region, col = region)) +\n  geom_line()\n\n\nApiData(\"http://data.ssb.no/api/v0/no/table/07459\",  returnMetaFrames = TRUE)\n\n\n\n\n\n\n\n# bef_agg <- befolkning2 %>% \n#   group_by( year, age_gr) %>% \n#   summarise(n = sum(bef_antall)) %>% \n#   ungroup()\n# \n# glimpse(bef_agg)\n# \n# ggplot(bef_agg, aes(x = year, y = n, linetype = age_gr, group = age_gr))+\n#   geom_line()+\n#   ylim(0,NA)\n# \n  \n\n## Inntekt\n\nmeta<- ApiData(\"http://data.ssb.no/api/v0/en/table/06944\",  returnMetaFrames = TRUE)\nnames(meta)\nmeta$Tid\nmeta$HusholdType\nmeta$ContentsCode\n\nkommuner_innt <- meta$Region %>% \n  filter(nchar(values) == 4 ) %>% \n  pull(values)\nhead(kommuner_innt)\n\n\ninnt_list <- ApiData(\"http://data.ssb.no/api/v0/en/table/06944\", \n                    ContentsCode = TRUE, \n                    Region = kommuner_innt, \n                    HusholdType = TRUE,  \n                    Tid = TRUE)\n\nglimpse(innt_list[[1]])\n\ninntekt <- cbind(innt_list[[2]][1], innt_list[[1]]) %>% \n  mutate(year = as.numeric(year)) %>% \n  select(-NAstatus) %>% \n  filter(!is.na(value)) %>% \n  rename(kommune = region, kommune_nr = Region,\n         hushold = `type of household`) %>% \n  mutate(contents = case_when(str_sub(contents,1,5) == \"Total\" ~ \"inntekt_totalt_median\",\n                             str_sub(contents,1,6) == \"Income\" ~ \"inntekt_eskatt_median\",\n                             str_sub(contents,1,6) == \"Number\" ~ \"ant_husholdninger\")) %>%\n  pivot_wider(values_from = value, names_from = contents)\n  \nglimpse(inntekt)\n\nhh_inntekt <- filter(inntekt, hushold == \"All households\") %>% \n  select(-hushold, -kommune)\nhead(hh_inntekt)\n\n\n\n\n\n\n\n\n## SOSIALHJLEP\n\nmeta<- ApiData(\"http://data.ssb.no/api/v0/en/table/12210\",  returnMetaFrames = TRUE)\nnames(meta)\nmeta$ContentsCode\nkokk <- meta$KOKkommuneregion0000 %>% \n  filter(!(values %in% c(\"EAK\", \"EAKUO\")) ) %>% \n  pull(values)\n\nglimpse(kokk)  \n\n\nshj_list <- ApiData(\"http://data.ssb.no/api/v0/en/table/12210\", \n                     ContentsCode = TRUE, \n                     KOKkommuneregion0000 = kokk, \n                     Tid = TRUE)\n\nshj <- cbind(shj_list[[2]], shj_list[[1]][1]) %>% \n  filter(!is.na(value)) %>% \n  pivot_wider(values_from = value, names_from = ContentsCode) %>% \n  rename(kommune_nr = KOKkommuneregion0000, \n          year = Tid,\n          shj_klienter = KOSsosantkliente0000 ,\n          shj_unge = KOSant18240000) %>% \n  select(kommune_nr, year, shj_klienter, shj_unge) %>% \n  mutate(year = as.numeric(year))\n  \n\nglimpse(shj)\n\n\n\n## Samle \n\n\nsamlet <- left_join(bef_tot, bef_menn, by = c(\"kommune_nr\", \"year\")) %>% \n  left_join(bef_kvinner, by = c(\"kommune_nr\", \"year\")) %>% \n  left_join(hh_inntekt, by = c(\"kommune_nr\", \"year\")) %>% \n  left_join( shj, by = c(\"kommune_nr\", \"year\")) %>% \n  left_join( anm, by = c(\"kommune_nr\", \"year\")) %>% \n  filter(year >= 2015) %>% \n  data.frame() %>% \n  filter(complete.cases(.)) \n\nglimpse(samlet)\n  \n\nsaveRDS(samlet , \"data/kommunedata.rds\")\n```\n:::\n",
    "supporting": [
      "innlesning_ssb_files\\figure-epub"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}