{
  "hash": "1d47e9a545b9ae3f1d8ef3aa96a68508",
  "result": {
    "engine": "knitr",
    "markdown": "# Import av Excel-filer\n\n\n::: {.cell}\n\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(readxl)\n```\n:::\n\n\nForbløffende mye data finnes i Excel-format. Selv om Excel ikke er designet for statistisk analyse, er det slik at svært mange organisasjoner, kommuner og offentlige etater lagrer og distribuerer data i Excel. Du vil nesten garantert støte på Excel-filer i løpet av studiene eller i arbeidslivet, så det er greit å vite hvordan du håndterer dem i R.\n\nExcel-filer kan være litt mer kronglete enn csv-filer fordi de kan inneholde flere ark, sammenslåtte celler, formatering og formler. Men R har gode verktøy for å håndtere dette.\n\n\n## Lese inn Excel-filer med `readxl`\n\nPakken `readxl` er den anbefalte pakken for å lese inn Excel-filer i R. Den er en del av tidyverse-familien og håndterer både `.xls` (gammelt format) og `.xlsx` (nytt format). Den enkleste bruken er helt rett frem:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwagepan_xlsx <- read_excel(\"data/wagepan_eksempel.xlsx\")\nglimpse(wagepan_xlsx)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 4,360\nColumns: 10\n$ nr      <dbl> 13, 13, 13, 13, 13, 13, 13, 13, 17, 17, 17, 17, 17, 17, 17, 17…\n$ year    <dbl> 1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1980, 1981, 19…\n$ hours   <dbl> 2672, 2320, 2940, 2960, 3071, 2864, 2994, 2640, 2484, 2804, 25…\n$ lwage   <dbl> 1.1975402, 1.8530600, 1.3444617, 1.4332134, 1.5681251, 1.69989…\n$ educ    <dbl> 14, 14, 14, 14, 14, 14, 14, 14, 13, 13, 13, 13, 13, 13, 13, 13…\n$ black   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ hisp    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ married <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1,…\n$ union   <dbl> 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…\n$ exper   <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 4, 5, 6, 7, 8, 9, 10, 11, 4, 5, 6, 7, …\n```\n\n\n:::\n:::\n\n\nFunksjonen `read_excel()` gjetter selv om det er `.xls` eller `.xlsx` basert på filendelsen. Du kan også bruke `read_xlsx()` eller `read_xls()` direkte hvis du vil være eksplisitt.\n\n\n## Velge ark med `sheet`\n\nEn Excel-fil kan inneholde flere ark (sheets). Som standard leser `read_excel()` inn det første arket. For å se hvilke ark som finnes i en fil kan du bruke `excel_sheets()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexcel_sheets(\"data/wagepan_eksempel.xlsx\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Sheet 1\"\n```\n\n\n:::\n:::\n\n\nDu kan velge ark enten med navn eller nummer:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Med navn\ndf <- read_excel(\"data/wagepan_eksempel.xlsx\", sheet = \"Sheet1\")\n\n# Med nummer (første ark)\ndf <- read_excel(\"data/wagepan_eksempel.xlsx\", sheet = 1)\n```\n:::\n\n\nHvis du trenger data fra flere ark kan du lese dem inn hver for seg og eventuelt koble dem sammen etterpå.\n\n\n## Håndtere overskriftsrader og hoppe over rader\n\nI praksis ser Excel-filer sjelden så ryddige ut som man skulle ønske. Det er vanlig at de første radene inneholder titler eller merknader som ikke er en del av dataene. Med `skip` hopper du over et gitt antall rader fra toppen:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Hopp over de 3 første radene\ndf <- read_excel(\"data/wagepan_eksempel.xlsx\", skip = 3)\n```\n:::\n\n\nNoen ganger har ikke filen variabelnavn i det hele tatt. Da kan du bruke `col_names`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Ingen overskriftsrad - R lager egne navn (X1, X2, ...)\ndf <- read_excel(\"data/wagepan_eksempel.xlsx\", col_names = FALSE)\n\n# Sett egne variabelnavn\ndf <- read_excel(\"data/wagepan_eksempel.xlsx\",\n                 col_names = c(\"id\", \"alder\", \"kjonn\", \"inntekt\"))\n```\n:::\n\n\n\n## Spesifisere celleområde med `range`\n\nHvis dataene bare ligger i en del av regnearket, kan du spesifisere nøyaktig hvilke celler som skal leses inn.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Les bare cellene B2 til F100\ndf <- read_excel(\"data/wagepan_eksempel.xlsx\", range = \"B2:F100\")\n\n# Du kan også spesifisere ark og celleområde samtidig\ndf <- read_excel(\"data/wagepan_eksempel.xlsx\", range = \"Sheet1!B2:F100\")\n```\n:::\n\n\nDu kan også bruke `cell_rows()` og `cell_cols()` for å spesifisere bare rader eller kolonner:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Bare radene 5 til 50\ndf <- read_excel(\"data/wagepan_eksempel.xlsx\", range = cell_rows(5:50))\n\n# Bare kolonnene A til D\ndf <- read_excel(\"data/wagepan_eksempel.xlsx\", range = cell_cols(\"A:D\"))\n```\n:::\n\n\n\n## Vanlige problemer med Excel-filer\n\n### Datoer\nExcel lagrer datoer som tall internt, og det kan noen ganger bli krøll ved innlesning. Hvis datoene ser rare ut (f.eks. som femsifrede tall), kan du konvertere dem:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Excel bruker 1899-12-30 som nullpunkt\nexcel_tall <- 44927\nas.Date(excel_tall, origin = \"1899-12-30\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"2023-01-01\"\n```\n\n\n:::\n:::\n\n\nSom regel håndterer `readxl` datoer automatisk, men det er greit å vite om dette.\n\n### Sammenslåtte celler\nSammenslåtte celler er en gjenganger. Ved innlesning får bare den første cellen verdien, resten blir `NA`. Løsningen er å fylle nedover med `tidyr::fill()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Eksempel: Fyll NA-verdier nedover (typisk etter sammenslåtte celler)\ndemo <- tibble(\n  kategori = c(\"Menn\", NA, NA, \"Kvinner\", NA, NA),\n  alder = c(\"18-29\", \"30-49\", \"50+\", \"18-29\", \"30-49\", \"50+\"),\n  antall = c(120, 340, 280, 135, 360, 295)\n)\n\ndemo %>%\n  fill(kategori, .direction = \"down\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n  kategori alder antall\n  <chr>    <chr>  <dbl>\n1 Menn     18-29    120\n2 Menn     30-49    340\n3 Menn     50+      280\n4 Kvinner  18-29    135\n5 Kvinner  30-49    360\n6 Kvinner  50+      295\n```\n\n\n:::\n:::\n\n\n### Flere tabeller i samme ark\nNoen bruker ett Excel-ark til å plassere flere tabeller ved siden av hverandre eller under hverandre. Da er `range`-argumentet din beste venn. Les inn hver tabell for seg med hvert sitt celleområde.\n\n### Tekst i tallkolonner\nHvis noen har skrevet en kommentar eller merknad i en celle som ellers inneholder tall, vil hele kolonnen kunne bli lest inn som tekst. Sjekk variabeltypene med `glimpse()` og konverter om nødvendig med `as.numeric()`.\n\n\n## Skrive Excel-filer\n\nNoen ganger trenger du å lagre data som Excel-fil, f.eks. fordi noen du samarbeider med foretrekker det. Pakken `openxlsx` er et godt alternativ:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(openxlsx)\n\n# Enkel eksport\nwrite.xlsx(wagepan_xlsx, file = \"data/eksempel_ut.xlsx\")\n\n# Med flere ark i samme fil\nwrite.xlsx(list(\"Datasett1\" = wagepan_xlsx,\n                \"Oppsummering\" = summary(wagepan_xlsx) %>% as.data.frame()),\n           file = \"data/eksempel_flere_ark.xlsx\")\n```\n:::\n\n\nEt enklere alternativ er pakken `writexl` som ikke har noen avhengigheter til Java eller andre systemer:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(writexl)\nwrite_xlsx(wagepan_xlsx, path = \"data/eksempel_ut.xlsx\")\n```\n:::\n\n\nBegge fungerer fint for enkel eksport. `openxlsx` gir deg mer kontroll over formatering, mens `writexl` er mer lettvektig og enklere å installere.\n\n\n## Tips for rotete Excel-filer\n\nI virkeligheten er Excel-filer ofte rotete. Her er noen praktiske tips:\n\n1. **Åpne filen i Excel først** og se på strukturen. Legg merke til hvilke rader og kolonner dataene faktisk ligger i.\n2. **Bruk `excel_sheets()`** for å se hvilke ark som finnes.\n3. **Start med `range`** hvis dataene ikke begynner i celle A1.\n4. **Sjekk variabeltypene** med `glimpse()` rett etter innlesning. Hvis en tallkolonne er blitt tekst, er det gjerne en kommentar eller et spesialtegn som lurer seg inn.\n5. **Bruk `fill()`** etter innlesning dersom det har vært sammenslåtte celler.\n6. **Unngå å redigere Excel-filen manuelt** for å \"rydde\" den. Skriv heller R-kode som håndterer rotet. Da er arbeidet reproduserbart og du slipper å gjøre det om igjen neste gang du får oppdaterte data.\n\nDet siste punktet er kanskje det viktigste. Det er fristende å fikse ting manuelt i Excel, men da mister du sporbarhet. Gjør du alt i R-kode, kan du og andre kjøre koden på nytt og få nøyaktig samme resultat.\n",
    "supporting": [
      "innlesning_excel_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}