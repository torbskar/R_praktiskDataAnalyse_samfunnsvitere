{
  "hash": "9ceb47d68bd13f835bbc102045ecde07",
  "result": {
    "engine": "knitr",
    "markdown": "# Import fra Stata og SPSS\n\n\n\n\n\n\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(haven)\nlibrary(labelled)\n```\n:::\n\n\n\n\n\n\n\n\nI forrige kapittel så vi kort hvordan man leser inn data fra Stata og SPSS. Det fungerer greit nok for de fleste formål, men det er noen utfordringer knyttet til *labelled* data som krever litt mer arbeid. Dette kapittelet går dypere inn i dette.\n\nHvis du jobber med data som opprinnelig er laget i Stata eller SPSS, vil du nesten garantert støte på det som kalles *labler*. Det er en spesiell måte å lagre informasjon om variablene på. R kan håndtere dette, men det er viktig å forstå hva som skjer og hvordan du bør rydde opp.\n\n## Hva er labelled data?\n\nI Stata og SPSS er det vanlig å bruke to typer labler:\n\n- **Value labels** (verdilabel): Knytter en tekst til en tallverdi. For eksempel kan verdien 0 ha labelen \"Not married\" og 1 ha labelen \"Married\".\n- **Variable labels** (variabellabel): En kort beskrivelse av hva variabelen inneholder. For eksempel kan variabelen `married` ha variabellabelen \"Sivilstatus\".\n\nNår du leser inn en Stata- eller SPSS-fil med `haven`, beholdes denne informasjonen. Men R behandler den annerledes enn det Stata og SPSS gjør. I R er disse verdiene fortsatt tall, men med labler vedlagt som metadata.\n\n## Lese inn data\n\nLa oss starte med å lese inn en Stata-fil:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwagepan <- read_stata(\"data/wagepan_eksempel.dta\")\nglimpse(wagepan)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 4,360\nColumns: 10\n$ nr      <dbl> 13, 13, 13, 13, 13, 13, 13, 13, 17, 17, 17, 17, 17, 17, 17, 17~\n$ year    <dbl> 1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1980, 1981, 19~\n$ hours   <dbl> 2672, 2320, 2940, 2960, 3071, 2864, 2994, 2640, 2484, 2804, 25~\n$ lwage   <dbl> 1.1975402, 1.8530600, 1.3444617, 1.4332134, 1.5681251, 1.69989~\n$ educ    <dbl> 14, 14, 14, 14, 14, 14, 14, 14, 13, 13, 13, 13, 13, 13, 13, 13~\n$ black   <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,~\n$ hisp    <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,~\n$ married <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1,~\n$ union   <dbl> 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,~\n$ exper   <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 4, 5, 6, 7, 8, 9, 10, 11, 4, 5, 6, 7, ~\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nLegg merke til variabeltypene. Der det står `<dbl+lbl>` betyr det at variabelen er numerisk (`dbl` = double), men at det finnes labler knyttet til verdiene. Dette er altså *labelled* variable.\n\n## Inspisere labler\n\nVi kan se på lablene til en enkelt variabel med `val_labels()`:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nval_labels(wagepan$married)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nNULL\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nVi kan også se variabellabelen (beskrivelsen av variabelen) med `var_label()`:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvar_label(wagepan$married)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Married\"\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nFor å få oversikt over alle variable med labler kan vi bruke `look_for()` fra `labelled`-pakken:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlook_for(wagepan)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n pos variable label               col_type missing values\n 1   nr       Person identifier   dbl      0             \n 2   year     Year                dbl      0             \n 3   hours    Annual hours worked dbl      0             \n 4   lwage    Log hourly wage     dbl      0             \n 5   educ     Years of education  dbl      0             \n 6   black    Black               dbl      0             \n 7   hisp     Hispanic            dbl      0             \n 8   married  Married             dbl      0             \n 9   union    Union member        dbl      0             \n 10  exper    Years of experience dbl      0             \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nDenne funksjonen gir en ryddig oversikt over variabelnavn, variabellabler, verdier og verdilabel. Det er veldig nyttig for å utforske datasett fra Stata og SPSS.\n\n## Problemet med labelled data i R\n\nLabelled data fungerer fint for å inspisere dataene, men de kan skape problemer når du skal gjøre analyser. Mange R-funksjoner forventer enten numeriske variable eller factor-variable, ikke labelled-variable. Du kan for eksempel oppleve at:\n\n- `ggplot` viser tallverdier i stedet for meningsfulle kategorinavn\n- Tabeller viser koder i stedet for tekst\n- Noen funksjoner gir uventede resultater eller feilmeldinger\n\nDerfor er det lurt å konvertere labelled variable til factor-variable tidlig i arbeidsprosessen.\n\n## Konvertere til factor\n\nDen enkleste måten å konvertere en labelled variabel til factor er med `as_factor()` fra `haven`:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwagepan <- wagepan %>%\n  mutate(married_factor = as_factor(married))\n\ntable(wagepan$married_factor)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n   0    1 \n2446 1914 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nMen hvis du har mange labelled variable, er det mye mer effektivt å konvertere alle på en gang med `across()`:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwagepan_clean <- wagepan %>%\n  mutate(across(where(is.labelled), ~as_factor(.)))\n\nglimpse(wagepan_clean)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 4,360\nColumns: 11\n$ nr             <dbl> 13, 13, 13, 13, 13, 13, 13, 13, 17, 17, 17, 17, 17, 17,~\n$ year           <dbl> 1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1980, 1~\n$ hours          <dbl> 2672, 2320, 2940, 2960, 3071, 2864, 2994, 2640, 2484, 2~\n$ lwage          <dbl> 1.1975402, 1.8530600, 1.3444617, 1.4332134, 1.5681251, ~\n$ educ           <dbl> 14, 14, 14, 14, 14, 14, 14, 14, 13, 13, 13, 13, 13, 13,~\n$ black          <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0~\n$ hisp           <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0~\n$ married        <dbl> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1~\n$ union          <dbl> 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0~\n$ exper          <dbl> 1, 2, 3, 4, 5, 6, 7, 8, 4, 5, 6, 7, 8, 9, 10, 11, 4, 5,~\n$ married_factor <fct> 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1~\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nDenne ene linjen konverterer *alle* labelled variable i datasettet til factor-variable. Det er den anbefalte metoden.\n\nNoen ganger vil du også fjerne ubrukte factor-nivåer som kan oppstå etter filtrering:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwagepan_clean <- wagepan %>%\n  mutate(across(where(is.labelled), ~as_factor(.)),\n         across(where(is.factor), ~fct_drop(.)))\n```\n:::\n\n\n\n\n\n\n\n\n## Brukerdefinertemissing-verdier\n\nI Stata og SPSS er det vanlig å bruke spesielle verdier for å markere ulike typer missing. For eksempel kan -9 bety \"ikke besvart\" og -8 bety \"ikke relevant\". Disse verdiene er ofte dokumentert med labler.\n\nPakken `haven` håndterer dette med *tagged NA*-verdier. Du kan sjekke om det finnes slike verdier:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Se brukerefinerte missing-verdier\nna_values(wagepan$hours)\n```\n:::\n\n\n\n\n\n\n\n\nI praksis er det ofte enklest å bare konvertere til factor (som gjort ovenfor) og deretter filtrere ut de kategoriene du ikke trenger. Alternativt kan du bruke `zap_labels()` for å fjerne alle labler og beholde bare tallverdiene:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwagepan_tall <- wagepan %>%\n  mutate(across(where(is.labelled), ~zap_labels(.)))\n```\n:::\n\n\n\n\n\n\n\n\nMen vær forsiktig med dette - da mister du all informasjon om hva verdiene betyr!\n\n## Lese inn SPSS-filer\n\nInnlesning av SPSS-filer fungerer på tilsvarende måte:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwagepan_spss <- read_spss(\"data/wagepan_eksempel.sav\")\nglimpse(wagepan_spss)\n```\n:::\n\n\n\n\n\n\n\n\nKonvertering til factor gjøres på nøyaktig samme måte:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwagepan_spss_clean <- wagepan_spss %>%\n  mutate(across(where(is.labelled), ~as_factor(.)),\n         across(where(is.factor), ~fct_drop(.)))\n```\n:::\n\n\n\n\n\n\n\n\n## Tegnsett og encoding\n\nEt vanlig problem med nordiske data er tegnsettproblemer. Norske bokstaver (æ, ø, å) kan vises feil hvis filen er lagret med et annet tegnsett enn det R forventer. Hvis du ser rare tegn i stedet for æøå, kan du prøve å spesifisere tegnsett ved innlesning:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Prøv med ulike tegnsett\nwagepan <- read_stata(\"data/wagepan_eksempel.dta\", encoding = \"latin1\")\n```\n:::\n\n\n\n\n\n\n\n\nDe vanligste tegnsettene er `\"UTF-8\"` og `\"latin1\"` (også kalt ISO-8859-1). Prøv begge hvis du har problemer.\n\n## Anbefalt arbeidsflyt\n\nHer er en anbefalt arbeidsflyt for å jobbe med data fra Stata eller SPSS:\n\n1. **Les inn** datafilen med `read_stata()` eller `read_spss()`\n2. **Inspiser** dataene med `glimpse()` og `look_for()`\n3. **Konverter** labelled variable til factor med `across(where(is.labelled), ~as_factor(.))`\n4. **Velg** de variablene du trenger med `select()`\n5. **Lagre** den ryddede versjonen som .rds for videre bruk\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Komplett arbeidsflyt\nwagepan_ferdig <- read_stata(\"data/wagepan_eksempel.dta\") %>%\n  mutate(across(where(is.labelled), ~as_factor(.)),\n         across(where(is.factor), ~fct_drop(.))) %>%\n  select(nr, year, hours, lwage, educ, married, union)\n\n# Lagre til .rds for videre bruk\nsaveRDS(wagepan_ferdig, \"data/wagepan_ferdig.rds\")\n```\n:::\n\n\n\n\n\n\n\n\nFordelen med å lagre som `.rds` er at du slipper å gjøre denne konverteringen hver gang. Neste gang du trenger dataene kan du bare laste inn .rds-filen direkte.\n\n## Oppsummering\n\n- Data fra Stata og SPSS har labler som R behandler som *labelled* data\n- Konverter til factor med `mutate(across(where(is.labelled), ~as_factor(.)))`\n- Bruk `look_for()` for å utforske variabelnavn og labler\n- Lagre ryddede data som `.rds` for effektiv videre bruk\n- Pass på tegnsettproblemer med nordiske bokstaver\n",
    "supporting": [
      "innlesning_stata_spss_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}