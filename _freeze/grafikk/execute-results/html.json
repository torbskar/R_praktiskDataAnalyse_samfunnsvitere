{
  "hash": "c140d4d0b7306faeb49190c05e043d33",
  "result": {
    "engine": "knitr",
    "markdown": "# Grafikk med ggplot\n\nResten av dette heftet belager seg på å bruke datasettet abu89 som er benyttet i en annen lærebok. Dataene kan lastes ned fra [den bokens hjemmeside](https://stata.fagbokforlaget.no/).\n\nFørst må dataene leses inn. Siden dette er data i stata-formatet dta, så brukes importfunksjonen `read_stata()`. Som nevnt tidligere bør variabler av typen labelled gjøres om til factor. Vi sletter også labler som ikke er i faktisk bruk. Disse to tingene gjørs med `as_factor()` og `fct_drop()`, men de er lagt inn i en funksjon som går gjennom alle variable i datasettet, `across()` og sjekker om de er av labelled-typen `where(is.labelled)`. Detaljene her er ikke sentrale for dette kurset: bare se å få lest inn dataene i R. \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(haven)\nlibrary(tidyverse)\n\nabu89 <- read_stata(\"data/abu89.dta\") %>% \n  mutate(across(where(is.labelled), ~as_factor(.)),\n         across(where(is.factor), ~fct_drop(.)))\n\nglimpse(abu89)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 4,127\nColumns: 9\n$ io_nr    <dbl> 3, 4, 5, 8, 11, 12, 13, 14, 16, 17, 18, 19, 20, 21, 22, 23, 2…\n$ time89   <dbl> 62.00000, NA, 91.32895, 84.23913, 90.42553, 103.28947, 75.000…\n$ ed       <dbl> 0, 1, 3, 5, 3, 1, 1, 7, 3, 9, 0, 9, 1, 3, 9, 3, 0, 3, 1, 3, 3…\n$ age      <dbl> 58, 24, 44, 46, 40, 36, 31, 31, 26, 29, 54, 58, 25, 25, 56, 5…\n$ female   <dbl> 1, 0, 1, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1…\n$ klasse89 <fct> III Rutinefunksjonærer, VIIa Ufaglærte arbeidere, II Nedre se…\n$ promot   <fct> NEI, JA, JA, NEI, NEI, NEI, NEI, NEI, JA, NEI, JA, JA, NEI, J…\n$ fexp     <dbl> 1.0, 0.3, 1.9, 0.3, 1.0, 1.2, 0.1, 0.4, 0.2, 0.3, 3.5, 3.1, 0…\n$ private  <fct> Public, Private, Private, Public, Private, Public, Public, Pr…\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n## Lagvis grafikk\nI R er det mange funksjoner for å lage grafikk. Noen er spesialiserte og knyttet til spesielle analysemetoder og gir deg akkurat det du trenger. Vi skal her bruke et *generelt system* for grafikk som heter `ggplot` som kan brukes til all slags grafikk. Funksjonen *ggplot* er bygget opp som en *gramatikk* for grafisk fremstilling. Det ligger en teori til grunn som er utledet i boken ved omtrent samme navn: [The grammar of graphics](https://link.springer.com/book/10.1007/0-387-28695-0). Det er mye som kan sies om dette, men det viktige er at grafikken er bygget opp rundt noen bestanddeler. Når du behersker disse kan du fremstille nær sagt hva som helst av kvantitativ informasjon grafisk. Dette er altså et system for grafikk, ikke bare kommandoer for spesifikke typer plot. Vi skal likevel bare se på grunnleggende typer plot her. \n\nSystemet er bygd opp *lagvis*. Det gjelder selve koden, men også hvordan det ser ut visuelt. Man kan utvide plottet med flere lag i samme plot og det legges da oppå hverandre i den rekkefølgen som angis i koden. \n\nFor enkle plot som vi skal bruke her angir man i denne rekkefølgen og med en `+` mellom hver del (vanligvis per linje, men linjeskift spiller ingen rolle). Hver del av koden spesifiserer enten *hva* som skal plottes eller *hvordan* det plottes, mens andre deler kan kontrollere utseende på akser, fargeskalaer, støttelinjer eller andre ting som har med layout å gjøre. \n\n1) Angi data og *hva* som skal plottes med `ggplot()`\n1) Angi *hvordan* det skal plottes med `geom_*()` \n1) Angi andre spesifikasjoner (farger, titler, koordinatsystemer osv)\n\nDette blir tydeligere i eksemplene og forklares underveis. \n\n* Det første argumentet i `ggplot` er data. Altså: hvilket datasett informasjonen hentes fra. \n* Inni `ggplot()` må det spesifiseres `aes()`, \"*aestethics*\", som er *hvilke variable* som skal plottes. Først og fremst hva som skal på x-akse og y-akse (og evt. z-akse), men også spesifikasjon av om linjer (farge, linjetype) og fyllfarger, skal angis etter en annen variabel. \n* `geom_*` står for *geometric* og sier noe om *hvordan* data skal se ut. Det kan være punkter, histogram, stolper, linjer osv. \n* `coord_*` definerer koordinatsystemet. Stort sett blir dette bestemt av variablene. Men du kan også snu grafen eller definere sirkulært koordinatsystem, eller andre enklere ting. \n* `facet_*` definerer hvordan du vil dele opp grafikken i undergrupper\n\n\n\n## Kategoriske variabel  \n\n### Stolpediagram \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggforce)\nggplot(abu89, aes(x = klasse89)) +\n  geom_bar() +\n  theme(axis.text.x = element_text(angle = 90))\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-2-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nNoen ganger ønsker man å vise fordelingen for to ulike grupper, la oss si for kjønn. En mulighet er da å rett og slett lage to stolpediagram ved siden av hverandre. Til dette kan man spesifisere at dataene er gruppert etter variabelen *female* og at fyllfargen skal settes etter denne variablen med `fill = factor(female)`. Merk bruken av `factor(female)` fordi variabelen er *numerisk* og det vil da ellers brukes en kontinuerlig fargeskale, mens å gjøre om variabelen til kategorisk brukes en annen fargeskala. \n\nI tillegg gjør vi her to ting til: setter et annet grafisk tema med `theme_minimal()` og snur plotvinduet slik at kategoriene er litt lettere å lese. Dette er smak og behag. \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(x = klasse89, group = female, fill = factor(female))) +\n  geom_bar(position=\"dodge\") +\n  theme_minimal()+\n  theme(axis.text.x = element_text(angle = 90))+\n  coord_flip()\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nEt alternativ er å plassere grafikken for menn og kvinner ved siden av hverandre. Å legge til `facet_wrap()` gjør dette. \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(x = klasse89)) +\n  geom_bar() +\n  facet_wrap(~factor(female)) +\n  theme(axis.text.x = element_text(angle = 90))\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nEt automatisk forvalg for `geom_bar()` er hvordan gruppene plasseres som er `position=\"stack\"`. Det betyr at gruppene stables oppå hverandre. Dette er godt egnet hvis poenget er å vise hvor mange av hvert kjønn som er i hver gruppe. Det er mindre egnet hvis du ønsker å sammenligne menn og kvinner. Da er alternativet å velge `position=\"dodge\"` som følger:  \n\n\n### Kakediagram  \n\nGenerelt er ikke kakediagram å anbefale da korrekt tolkning involverer å tolke et areal som inneholder vinkel. Med få kategorier som er rimelig forskjellig kan det gi et ok inntrykk, men ofte ender man opp med å måtte skrive på tallene likevel. Vi tar det med her egentlig bare fordi mange insisterer på å bruke det. Så vet du at det er mulig. \n\nDet enkleste er å bruke funksjonen `pie()` som gir følgende resultat. \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntab <- table(abu89$klasse89) \ntab\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n    I Øvre serviceklasse   II Nedre serviceklasse   III Rutinefunksjonærer \n                     328                     1181                     1248 \n V-VI Faglærte arbeidere VIIa Ufaglærte arbeidere \n                     648                      637 \n```\n\n\n:::\n\n```{.r .cell-code}\npie(tab)\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nMen hvis man skal bruke ggplot er det litt mer jobb. Fordelen med ggplot er at du har bedre kontroll for å lage publiserbar kvalitet. (Akkurat for kakediagram er det kanskje ikke så farlige, for du bør ikke bruke det i publikasjoner hvis du kan la være).\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npc <- abu89 %>% \n  group_by(klasse89) %>% \n  summarise(n = n()) %>% \n  mutate(pct = n/sum(n)*100) %>% \n  ungroup()\n\nggplot(pc, aes(x = \"\", y = pct, fill = (klasse89))) +\n  geom_bar(stat=\"identity\", width=1) +\n  coord_polar(\"y\", start=0) +\n  theme_void()+\n  geom_text( aes(label = paste0( round(pct,1), \"%\"), x = 1.4), \n            position = position_stack(vjust=.5), check_overlap = F) +\n  labs(x = NULL, y = NULL, fill = NULL)+\n  theme(axis.line = element_blank(),\n          axis.text = element_blank(),\n          axis.ticks = element_blank()) +\n  scale_fill_brewer(palette=\"Blues\", direction = -1)\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n\n## Kontinuerlige variable \n\n\n\n\n### Histogram \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(x = time89)) +\n  geom_histogram()\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nDet er også vanlig å fremstille det samme på en \"tetthetsskala\", der arealet summeres til 1. Det betyr at arealet for hvert intervall tilsvarer en andel. Visuelt sett er det vel så mye arealet vi oppfatter som høyden på stolpene. Men det er bare skalaen på y-aksen som har endret seg. Visuelt sett, ser histogrammene helt like ut. \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(x = time89, y = ..density..)) +\n  geom_histogram()\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n### Density plot \nDensity plot er en måte å fremstille det samme på, men i stedet for å dele inn i intervaller som i histogram lager vi en glattet kurve. Det blir på skalaen \"tetthet\" som i histogrammet ovenfor. \n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(x = time89)) +\n  geom_density()\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(x = time89)) +\n  geom_histogram(aes(y = ..density..), fill = \"lightgrey\", col = \"grey\") +\n  geom_density(col = \"red\", linewidth = 1) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nEn fordel med denne fremstillingen er at det er lettere å sammenligne grupper. Her er et eksempel med density plot etter hvor mye man drikker. \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(x = time89, group = klasse89, linetype = klasse89)) +\n  geom_density(linewidth = 1)+\n  guides(fill = guide_legend(override.aes = list(shape = 1 ) ) ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(x = time89)) +\n  geom_density(linewidth = 1)+\n  theme_minimal()+\n  facet_wrap(~klasse89, scales=\"free\")\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(x = time89, group = female,  fill = factor(female))) +\n  geom_density(alpha = .3)+\n  guides(fill=guide_legend(title=\"Kjønn\"))+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n### Flere variable samtidig \n\n\n####  Boksplot \n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(y = time89, group = klasse89)) +\n  geom_boxplot()+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n\n\n#### Scatterplot \n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(x = age, y = time89)) +\n  geom_point(alpha=.3)+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(abu89, aes(x = age, y = time89)) +\n  geom_jitter(alpha=.1, width = .3)+\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n#### Ridgeplot \n\nRidgeplot er en annen måte å sammenligne en kontinuerlig fordeling betinget på en gruppering. \n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(ggridges)\nggplot( abu89,  aes(y = klasse89, x = time89)) +\n  geom_density_ridges() \n```\n\n::: {.cell-output-display}\n![](grafikk_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n## Oppgaver\n\nSlå opp i boken [R for data science](https://r4ds.had.co.nz/data-visualisation.html) hvis du står fast eller ikke skjønner hva koden betyr. \n\n::: {#exr-}\nLast ned datasettet abu89 fra angitt hjemmeside og les inn dataene til R som vist ovenfor. Lag den samme grafikken som vist her, gjør noen endringer på kodene for å endre utseendet på plottene. Det er et mål at du skal forstå hva hver enkelt kommando gjør. \n:::\n\n\n::: {#exr-}\nLast inn datasettet `wagepan` fra pakken `wooldridge` i R. Velg noen variable som du selv tenker kan være informative å se nærmere på. Bruk de samme teknikkene på disse variablene.\n:::\n\n",
    "supporting": [
      "grafikk_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}