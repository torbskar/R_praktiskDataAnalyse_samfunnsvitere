{
  "hash": "4535f829eb0842b0264cf096eb87496c",
  "result": {
    "engine": "knitr",
    "markdown": "# Marginaleffekter\n\n\n\n\n\n\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(haven)\nlibrary(marginaleffects)\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n\n\n\nI de foregående kapitlene har vi sett på lineær regresjon og logistisk regresjon. I lineær regresjon er regresjonskoeffisientene greie å tolke direkte: de uttrykker endring i gjennomsnittlig verdi på utfallsvariabelen per enhets endring i forklaringsvariabelen. Men i logistisk regresjon er koeffisientene på log-odds-skalaen, og det er ikke spesielt intuitivt. Vi kan eksponentiere til oddsratioer, men det er heller ikke alltid lett å forklare hva en oddsratio *betyr* i praksis.\n\nHer kommer *marginaleffekter* inn i bildet. Marginaleffekter lar oss uttrykke effekten av en forklaringsvariabel som endring i sannsynlighet, noe som er langt mer intuitivt. Pakken `{marginaleffects}` gir oss et samlet rammeverk for å beregne marginaleffekter, predikerte verdier og sammenligninger mellom grupper. Hvis du ikke har installert pakken fra før:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"marginaleffects\")\n```\n:::\n\n\n\n\n\n\n\n\n\n## Eksempelmodeller\nVi trenger noen modeller å jobbe med. La oss estimere en lineær modell for timelønn og en logistisk modell for sannsynligheten for å ha høy lønn. Først lager vi en dummy for høy lønn, definert som timelønn over medianen.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nabu89 <- abu89 %>%\n  filter(!is.na(time89)) %>%\n  mutate(hoy_lonn = ifelse(time89 > median(time89, na.rm = TRUE), 1, 0))\n```\n:::\n\n\n\n\n\n\n\n\nSå estimerer vi to modeller:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_mod <- lm(time89 ~ age + female + ed, data = abu89)\nlogit_mod <- glm(hoy_lonn ~ age + female + ed,\n                 data = abu89, family = binomial)\n```\n:::\n\n\n\n\n\n\n\n\nI den lineære modellen kan vi lese koeffisientene direkte, men i den logistiske modellen er koeffisientene på log-odds-skalaen:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoef(logit_mod)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n(Intercept)         age      female          ed \n-1.84743222  0.03867057 -1.58421620  0.41064784 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nDet er her marginaleffekter kommer inn.\n\n\n## Gjennomsnittlige marginaleffekter (AME)\nDen vanligste bruken er å beregne *Average Marginal Effects* (AME). Det betyr at vi beregner den marginale effekten for hver observasjon og tar gjennomsnittet. Funksjonen `avg_slopes()` gjør nettopp dette.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(logit_mod)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n   Term Contrast Estimate Std. Error     z Pr(>|z|)     S    2.5 %   97.5 %\n age       dY/dX  0.00693   0.000538  12.9   <0.001 123.7  0.00588  0.00799\n ed        dY/dX  0.07362   0.002552  28.8   <0.001 605.6  0.06862  0.07862\n female    1 - 0 -0.30865   0.014233 -21.7   <0.001 344.0 -0.33655 -0.28076\n\nType: response\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nNå er effektene uttrykt som endring i sannsynlighet. For eksempel betyr en effekt av `female` på -0.10 at kvinner i gjennomsnitt har 10 prosentpoeng lavere sannsynlighet for høy lønn sammenlignet med menn, alt annet likt.\n\nFor den lineære modellen gir `avg_slopes()` de samme verdiene som de vanlige regresjonskoeffisientene, fordi marginaleffekten er lik overalt i en lineær modell:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(lm_mod)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n   Term Contrast Estimate Std. Error     z Pr(>|z|)     S   2.5 %  97.5 %\n age       dY/dX    0.542     0.0332  16.3   <0.001 196.6   0.477   0.607\n ed        dY/dX    4.874     0.1626  30.0   <0.001 653.0   4.555   5.192\n female    1 - 0  -17.601     0.8255 -21.3   <0.001 332.7 -19.219 -15.983\n\nType: response\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n## Marginaleffekter ved bestemte verdier\nNoen ganger vil man vite hva marginaleffekten er ved *bestemte* verdier av forklaringsvariablene. Funksjonen `slopes()` gjør dette. Med `datagrid()` kan vi lage et datasett med bestemte verdier, der variable som ikke spesifiseres holdes på gjennomsnittsverdier.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nslopes(logit_mod,\n       variables = \"ed\",\n       newdata = datagrid(age = c(25, 40, 55)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n age Estimate Std. Error    z Pr(>|z|)     S  2.5 % 97.5 %\n  25   0.0996    0.00458 21.7   <0.001 344.9 0.0906 0.1085\n  40   0.0833    0.00366 22.8   <0.001 379.2 0.0761 0.0904\n  55   0.0608    0.00327 18.6   <0.001 254.2 0.0544 0.0672\n\nTerm: ed\nType: response\nComparison: dY/dX\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nHer ser vi at effekten av utdanning varierer med alder. Det er fordi logistisk regresjon er ikke-lineær: den marginale effekten avhenger av *hvor* på fordelingen man befinner seg.\n\n\n## Predikerte verdier\nI kapittelet om lineær regresjon brukte vi `predict()` for å beregne predikerte verdier. Pakken `{marginaleffects}` har tilsvarende funksjoner som gir ryddigere output med konfidensintervaller. Funksjonen `predictions()` gir predikerte verdier, mens `avg_predictions()` gir gjennomsnitt per gruppe.\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredictions(logit_mod,\n            newdata = datagrid(age = c(25, 35, 45, 55),\n                               female = c(0, 1)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n age female Estimate Pr(>|z|)     S 2.5 % 97.5 %\n  25      0    0.587   <0.001  22.6 0.555  0.618\n  25      1    0.226   <0.001 192.5 0.201  0.253\n  35      0    0.677   <0.001 134.7 0.653  0.700\n  35      1    0.300   <0.001 144.4 0.276  0.326\n  45      0    0.755   <0.001 258.0 0.732  0.776\n  45      1    0.387   <0.001  45.5 0.360  0.415\n  55      0    0.819   <0.001 267.6 0.795  0.841\n  55      1    0.482    0.331   1.6 0.445  0.518\n\nType: invlink(link)\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nMed `avg_predictions()` kan vi beregne gjennomsnittlig predikert sannsynlighet fordelt på grupper:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_predictions(logit_mod, by = \"female\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n female Estimate Std. Error    z Pr(>|z|)     S 2.5 % 97.5 %\n      0    0.660    0.00968 68.2   <0.001   Inf 0.641  0.679\n      1    0.305    0.00984 31.0   <0.001 700.1 0.286  0.325\n\nType: response\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n## Sammenligninger mellom grupper\nFunksjonen `avg_comparisons()` beregner gjennomsnittlige forskjeller mellom grupper eller ved endring i en variabel. For eksempel forskjellen mellom menn og kvinner:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_comparisons(logit_mod, variables = \"female\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Estimate Std. Error     z Pr(>|z|)     S  2.5 % 97.5 %\n   -0.309     0.0142 -21.7   <0.001 344.0 -0.337 -0.281\n\nTerm: female\nType: response\nComparison: 1 - 0\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nVi kan også se på effekten av en bestemt endring i en kontinuerlig variabel, for eksempel fra 10 til 15 års utdanning:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_comparisons(logit_mod,\n                variables = list(ed = c(10, 15)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Estimate Std. Error    z Pr(>|z|)    S  2.5 % 97.5 %\n   0.0547    0.00619 8.83   <0.001 59.8 0.0426 0.0668\n\nTerm: ed\nType: response\nComparison: 15 - 10\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n## Plotting av marginaleffekter\nEn stor styrke med `{marginaleffects}` er enkle og fine plot. Funksjonen `plot_predictions()` viser predikerte verdier, mens `plot_slopes()` viser hvordan marginaleffekten varierer.\n\nHer plotter vi predikert sannsynlighet for høy lønn som funksjon av alder, separat for menn og kvinner:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_predictions(logit_mod, condition = c(\"age\", \"female\"))\n```\n\n::: {.cell-output-display}\n![](marginaleffekter_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nDen grå sonen viser konfidensintervallet. Vi ser den karakteristiske S-formen fra logistisk regresjon. For den lineære modellen blir linjene rette:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_predictions(lm_mod, condition = c(\"age\", \"female\"))\n```\n\n::: {.cell-output-display}\n![](marginaleffekter_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nMed `plot_slopes()` kan vi visualisere hvordan marginaleffekten av en variabel varierer med en annen:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_slopes(logit_mod, variables = \"ed\", condition = \"age\")\n```\n\n::: {.cell-output-display}\n![](marginaleffekter_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\nSiden disse funksjonene returnerer ggplot-objekter, kan de tilpasses med vanlig ggplot-syntaks:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_predictions(logit_mod, condition = c(\"age\", \"female\")) +\n  labs(x = \"Alder\",\n       y = \"Predikert sannsynlighet for høy lønn\",\n       color = \"Kjønn\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](marginaleffekter_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n## Sammenhengen med predict()\nI kapittelet om lineær regresjon brukte vi `predict()` for å beregne predikerte verdier. Her er en kort sammenligning:\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnyedata <- data.frame(age = 40, female = 0, ed = 12)\n\n# Med predict():\npredict(logit_mod, newdata = nyedata, type = \"response\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        1 \n0.9903123 \n```\n\n\n:::\n\n```{.r .cell-code}\n# Med predictions():\npredictions(logit_mod, newdata = nyedata)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n Estimate Pr(>|z|)     S 2.5 % 97.5 %\n     0.99   <0.001 408.6 0.986  0.993\n\nType: invlink(link)\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\nBegge gir samme predikerte verdi, men `predictions()` gir i tillegg konfidensintervaller og standardfeil. Funksjonen `predict()` er innebygd i R og fungerer alltid, men `{marginaleffects}` gir ryddigere output og er enklere for mer avanserte ting.\n\n\n## Oppsummering\n\n| Funksjon | Hva den gjør |\n|----------|-------------|\n| `avg_slopes()` | Gjennomsnittlige marginaleffekter (AME) |\n| `slopes()` | Marginaleffekter ved bestemte verdier |\n| `predictions()` | Predikerte verdier for angitte observasjoner |\n| `avg_predictions()` | Gjennomsnittlige predikerte verdier per gruppe |\n| `avg_comparisons()` | Gjennomsnittlige sammenligninger mellom grupper |\n| `plot_predictions()` | Plot av predikerte verdier |\n| `plot_slopes()` | Plot av marginale effekter |\n\nHovedpoenget er at marginaleffekter lar oss tolke resultater fra ikke-lineære modeller (som logistisk regresjon) på en intuitiv skala. I stedet for log-odds eller oddsratioer kan vi snakke om endring i sannsynlighet, noe som er langt lettere å forstå.\n",
    "supporting": [
      "marginaleffekter_files\\figure-html"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}