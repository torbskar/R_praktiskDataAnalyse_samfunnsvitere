# Reproduserbarhet

```{r}
#| echo: false
invisible(Sys.setlocale(locale='no_NB.utf8'))
```

Forskning handler om å finne ut noe om verden, og det er viktig at andre kan etterprøve det vi har gjort. Reproduserbarhet betyr ganske enkelt at noen andre skal kunne ta dine data og din kode, kjøre analysen på nytt, og få nøyaktig samme resultat. Det høres kanskje selvfølgelig ut, men det er overraskende vanskelig i praksis.

En del av grunnen til at vi bruker R og skriver kode er nettopp dette: alt vi gjør er dokumentert i et script. Det er ingen skjulte klikk i menyer som ingen husker etterpå. Men det kreves litt disiplin for å gjøre det ordentlig. Dette kapittelet handler om praktiske grep du kan ta for å gjøre analysene dine reproduserbare.


## Replikasjonskrisen
I løpet av de siste årene har det blitt avdekket at overraskende mange forskningsresultater ikke lar seg reprodusere. Dette omtales ofte som "replikasjonskrisen" og har særlig rammet psykologi og andre samfunnsvitenskapelige fag. Studier som forsøkte å gjenta klassiske eksperimenter fant at bare omtrent halvparten ga tilsvarende resultater som det opprinnelige studiet. Årsakene er sammensatte og handler om mye mer enn kode og data, men en viktig del av løsningen er åpenhet om hvordan analyser er gjennomført. Det starter med at analysekoden er tilgjengelig og at andre faktisk kan kjøre den.


## Bruk script -- ikke pek-og-klikk
Det mest grunnleggende grepet for reproduserbarhet er å gjøre *alt* i et script. Alt du gjør i analysen skal stå i koden. Du skal ikke gjøre noe manuelt som ikke er dokumentert. Det betyr for eksempel at du ikke skal sortere data i Excel, ikke redigere datafiler for hånd, og ikke kopiere tall fra R-output og lime inn i et Word-dokument manuelt.

Grunnen er enkel: hvis du gjør noe manuelt, så er det ingen garanti for at du (eller noen andre) kan gjøre nøyaktig det samme om igjen. Og du vil garantert glemme hva du gjorde etter noen måneder.


## R-prosjekter og filstier
En av de vanligste kildene til problemer med reproduserbarhet er filstier. Hvis koden din inneholder noe slikt:

```{r}
#| eval: false
data <- read.csv("C:/Users/torbjorn/Mine dokumenter/masteroppgave/data/survey.csv")
```

...så vil denne koden bare fungere på akkurat din datamaskin. Ingen andre har den samme mappestien. Løsningen er å bruke **R-prosjekter** (.Rproj-filer) og **relative filstier**.

Når du åpner et R-prosjekt i RStudio, settes arbeidskatalogen automatisk til mappen der .Rproj-filen ligger. Da kan du skrive:

```{r}
#| eval: false
data <- read.csv("data/survey.csv")
```

Dette fungerer for alle som har prosjektmappen, uansett hvor på datamaskinen den ligger. Opprett et nytt prosjekt via *File > New Project* i RStudio.

### Aldri bruk `setwd()`
Du har kanskje sett at noen bruker `setwd()` for å sette arbeidskatalogen. Ikke gjør det. Problemet er det samme som med absolutte filstier: `setwd("C:/Users/torbjorn/prosjekt")` fungerer bare på din maskin. I tillegg gjør det at koden blir avhengig av *rekkefølgen* ting kjøres i, noe som gjør det vanskeligere å feilsøke. Bruk R-prosjekter i stedet, så slipper du `setwd()` helt.


### `here`-pakken for filstier
Selv med R-prosjekter kan det noen ganger være litt klønete med filstier, særlig i Quarto-dokumenter der arbeidskatalogen er mappen der .qmd-filen ligger, ikke prosjektets rotmappe. Pakken `here` løser dette elegant:

```{r}
#| eval: false
library(here)
data <- read.csv(here("data", "survey.csv"))
```

Funksjonen `here()` finner alltid prosjektets rotmappe (der .Rproj-filen ligger) og bygger filstien derfra. Det fungerer uansett hvor i prosjektmappen scriptet ditt befinner seg.


## Kommenter koden din
God kode er kode som andre kan lese og forstå. Og med "andre" mener vi også deg selv om seks måneder. Bruk kommentarer (`#`) for å forklare *hvorfor* du gjør noe, ikke bare *hva* du gjør. R ignorerer alt som står etter `#` på en linje.

```{r}
#| eval: false
# Fjerner observasjoner med manglende inntektsdata
# fordi disse er kodet som -1 i rådataene
data <- data %>%
  filter(inntekt >= 0)
```

Du trenger ikke kommentere hver eneste linje, men de stegene der det ikke er opplagt hva som skjer eller *hvorfor* du gjør det, bør ha en kommentar.


## Quarto og R Markdown for rapporter
Denne boken er skrevet i Quarto, og det er et godt eksempel på hvordan man kan kombinere tekst og kode i ett dokument. Når du skriver en oppgave eller rapport i Quarto, ligger all kode og alle resultater i samme fil. Det betyr at du aldri trenger å kopiere tall fra R-output og lime inn i Word. Resultatene genereres direkte fra koden, og hvis data endres, oppdateres alt automatisk.

For semesteroppgaver og masteroppgaver er det veldig lurt å skrive i Quarto. Du slipper mye rot med å holde styr på hvilke tall som hører til hvilken analyse, og du unngår feil som oppstår ved manuell kopiering av resultater.


## Versjonskontroll med Git
Har du noen gang hatt filer som heter `analyse_v2.R`, `analyse_v3_endelig.R`, `analyse_v3_endelig_VIRKELIG.R`? Da trenger du versjonskontroll.

**Git** er et system for å holde styr på endringer i filer over tid. Hver gang du gjør en meningsfull endring, lager du et "commit" -- et slags øyeblikksbilde av filene dine. Du kan alltid gå tilbake til en tidligere versjon, og du kan se nøyaktig hva som ble endret og når.

Git brukes mest via kommandolinjen, men RStudio har innebygd støtte for Git slik at du kan gjøre de vanligste operasjonene direkte i RStudio. For å komme i gang med Git trenger du å installere det og koble det til RStudio. Det er litt oppsett første gangen, men når det er på plass er det veldig nyttig. For de fleste studentprosjekter er det nok å lære seg de grunnleggende operasjonene: `commit`, `push` og `pull`.

Vi går ikke i detalj om Git her, men det er verdt å vite at det finnes og at det er standard verktøy for versjonskontroll i de fleste fagmiljøer.


## Pakkeversjoner med `renv`
R-pakker oppdateres hele tiden, og noen ganger kan en ny versjon av en pakke gi andre resultater enn den gamle. For å sikre at analysen din gir samme resultat om et år, kan du bruke pakken `renv` til å "fryse" pakkene i prosjektet ditt.

```{r}
#| eval: false
# Initialiser renv i prosjektet
renv::init()

# Etter at du har installert alle pakkene du trenger:
renv::snapshot()
```

Kommandoen `renv::snapshot()` lager en fil (`renv.lock`) som inneholder en oversikt over alle pakkene du bruker og nøyaktig hvilke versjoner som er installert. Hvis noen andre skal kjøre koden din, kan de bruke `renv::restore()` for å installere nøyaktig de samme versjonene.

For en masteroppgave eller et forskningsprosjekt er dette et veldig godt grep. For vanlige semesteroppgaver er det kanskje ikke strengt nødvendig, men det er greit å vite at muligheten finnes.


## Dele data og kode
Reproduserbarhet handler også om at andre faktisk har *tilgang* til data og kode. To vanlige plattformer for dette er:

- **GitHub**: Et nettsted for å dele kode og samarbeide om prosjekter. GitHub er tett integrert med Git og er standard plattform i mange fagmiljøer. Du kan opprette en konto gratis på [github.com](https://github.com).

- **Open Science Framework (OSF)**: En plattform laget spesifikt for forskning, der du kan dele data, kode, og annen dokumentasjon. OSF er mye brukt i samfunnsvitenskap og er tilgjengelig på [osf.io](https://osf.io).

For en masteroppgave kan det være veldig nyttig å legge kode og data (hvis dataene kan deles) på en av disse plattformene. Det viser at du tar reproduserbarhet på alvor, og det gjør det lett for veileder å se på koden din.


## Dokumenter R-miljøet ditt
En enkel ting du kan gjøre helt til slutt i ethvert prosjekt er å dokumentere hvilken versjon av R og hvilke pakker du har brukt. Funksjonen `sessionInfo()` gir deg alt du trenger:

```{r}
#| eval: false
sessionInfo()
```

Dette skriver ut R-versjon, operativsystem, og alle pakkene som er lastet inn med versjonsnumre. Hvis noen har problemer med å reprodusere resultatene dine, er dette det første stedet å se etter forskjeller. Legg gjerne til `sessionInfo()` helt sist i Quarto-dokumentet ditt.


## Sjekkliste for reproduserbare prosjekter
Her er en praktisk sjekkliste du kan bruke for å sjekke at prosjektet ditt er rimelig reproduserbart:

- [ ] All analyse er gjort i script (ingen manuelle steg)
- [ ] Prosjektet bruker en .Rproj-fil
- [ ] Alle filstier er relative (ingen `setwd()`, ingen absolutte stier)
- [ ] Koden er kommentert der det trengs
- [ ] Rapporten er skrevet i Quarto eller R Markdown
- [ ] `sessionInfo()` er inkludert i dokumentet
- [ ] Data og kode er organisert i en logisk mappestruktur
- [ ] Prosjektet kan kjøres fra start til slutt uten feil på en annen maskin

Du trenger ikke krysse av alt for en vanlig semesteroppgave, men jo flere punkter du får med, desto bedre. For en masteroppgave bør du sikte på å få med alt.
